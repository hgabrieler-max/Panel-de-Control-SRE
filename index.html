<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho - JS Simple (Frecuencias)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .unit-card { transition: background-color 0.2s; }
        body {
            background-color: #e6f2e6;
        }
        .nature-bg {
            background: linear-gradient(135deg, #e6f2e6 0%, #cce3d6 100%);
        }
        .nature-glass {
            background: rgba(255,255,255,0.65);
            box-shadow: 0 4px 24px rgba(34, 49, 34, 0.12);
            border: 1px solid rgba(34, 49, 34, 0.08);
            backdrop-filter: blur(3px);
        }
        /* Transiciones suaves para cambios de tema */
        body, .nature-bg, .nature-glass, .unit-card, .bg-white, .bg-gray-50, input, select, textarea, button {
            transition: background-color 320ms ease, color 320ms ease, border-color 320ms ease, box-shadow 320ms ease;
        }
        svg { transition: transform 320ms ease, fill 320ms ease, stroke 320ms ease; }
        /* Dark mode overrides */
        .dark body { background-color: #071026; }
        .dark .nature-bg { background: linear-gradient(135deg,#071726 0%,#0b2230 100%); }
        .dark .nature-glass {
            background: rgba(6,10,18,0.7) !important;
            box-shadow: 0 4px 24px rgba(2,6,23,0.7) !important;
            border: 1px solid rgba(255,255,255,0.04) !important;
            color: #e6eef8 !important;
        }
        .dark .bg-white, .dark .bg-gray-50, .dark .bg-gray-100 {
            background-color: #0b1220 !important;
            color: #dbeafe !important;
        }
        /* Inputs, selects y textarea en modo oscuro */
        .dark input, .dark select, .dark textarea, .dark .border {
            background-color: #071226 !important;
            color: #e6eef8 !important;
            border-color: rgba(255,255,255,0.06) !important;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: rgba(230,238,248,0.55) !important;
        }
        .dark select option { background-color: #071226; color: #e6eef8; }
        .dark .text-gray-700, .dark .text-gray-600, .dark .text-gray-500 { color: #cbd5e1 !important; }
        .dark .text-gray-800, .dark .text-gray-900 { color: #e6eef8 !important; }
        .dark .bg-gray-300, .dark .bg-gray-200 { background-color: #1f2937 !important; color: #e6eef8 !important; }
        .dark .bg-gray-300:hover { background-color: #374151 !important; }
    .dark .unit-card { background: transparent !important; }
    /* Improve visibility of unit cards in dark mode: subtle elevation and left-side glow matching the border color */
    .dark .unit-card { box-shadow: 0 6px 18px rgba(2,6,23,0.45); }
    /* Colored left glows for common border utilities used on unit cards */
    .dark .unit-card.border-red-500 { box-shadow: 0 6px 18px rgba(2,6,23,0.45), -6px 0 18px rgba(220,38,38,0.18); }
    .dark .unit-card.border-green-500 { box-shadow: 0 6px 18px rgba(2,6,23,0.45), -6px 0 18px rgba(16,185,129,0.16); }
    .dark .unit-card.border-yellow-400, .dark .unit-card.border-yellow-500 { box-shadow: 0 6px 18px rgba(2,6,23,0.45), -6px 0 18px rgba(234,179,8,0.16); }
    .dark .unit-card.border-gray-500, .dark .unit-card.border-gray-400 { box-shadow: 0 6px 18px rgba(2,6,23,0.45), -6px 0 18px rgba(107,114,128,0.12); }
    /* Fallback stronger left border for cards that remain hard to see */
    .dark .unit-card { outline: 1px solid rgba(255,255,255,0.02); }
          /* Ensure freq/status indicators are hidden in light mode and shown only in dark mode
              This is explicit CSS so it works even if Tailwind's generated dark: variants are missing */
          .freq-indicator, .status-indicator { display: none !important; }
          .dark .freq-indicator, .dark .status-indicator { display: inline-block !important; }
        /* Type-specific darker bars */
        .dark [data-type="Warden"] { background-color: #071033 !important; color: #bfdbfe !important; }
        .dark [data-type="Ranger"] { background-color: #052713 !important; color: #bbf7d0 !important; }
        .dark [data-type="AIR"] { background-color: #0b0f12 !important; color: #cbd5e1 !important; }
        .dark [data-type="TSU"] { background-color: #2b2a07 !important; color: #fef3c7 !important; }
        .dark [data-type="ISB"] { background-color: #071229 !important; color: #bfdbfe !important; }
          /* Neutralize per-type full-header backgrounds in dark mode so headers remain neutral
              and only the small .type-strip indicates the type color (matches Lifeguard style) */
          .dark [data-type] { background-color: transparent !important; color: inherit !important; }
        /* Visual for drag-over when reordering categories */
        .drag-over { outline: 3px dashed rgba(59,130,246,0.45); transform: translateY(-2px); }
        /* Large subtle background logo for State Parks */
        .nature-bg {
            position: relative;
            overflow: visible;
        }
        /* Use a pseudo-element so the logo sits behind content and can be toned down */
        .nature-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            /* Use CSS variable so JS can set a working path dynamically, with a default fallback */
            background-image: var(--bg-logo-url, url('../Pictures/Screenshots/san_andreas_state_parks_logo.png'));
            background-repeat: no-repeat;
            background-position: center 30%;
            /* slightly larger and more visible */
            background-size: 45% auto;
            opacity: 0.14;
            pointer-events: none;
            z-index: 0;
            filter: saturate(0.5) brightness(1.05);
        }
        /* Stronger logo visibility in dark mode */
        .dark .nature-bg::before {
            opacity: 0.18 !important;
            filter: saturate(0.6) brightness(1.05) contrast(0.95) !important;
        }
        /* (secondary logo removed) */
        /* Ensure main content sits above the pseudo-element */
        .nature-bg > * { position: relative; z-index: 2; }
    /* Visible resizers between columns */
        .visible-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px; /* interactive hit area */
            margin-left: -6px; /* center over boundary */
            background: transparent; /* invisible */
            border-left: none;
            border-right: none;
            cursor: col-resize;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* ensure fully transparent */
        }
        .visible-resizer:hover { background: transparent; }
        .resizer-handle {
            width: 18px; height: 18px; border-radius: 50%; background: rgba(34,197,94,0.9); border: none; opacity: 0; transition: opacity 120ms ease;
            display:block; cursor: pointer;
        }
        .visible-resizer:hover .resizer-handle { opacity: 1; }
        .resizer-popup {
            position: absolute; right: 22px; top: 6px; background: white; border: 1px solid rgba(0,0,0,0.08); padding: 8px; border-radius: 6px; z-index: 10000; box-shadow: 0 6px 24px rgba(2,6,23,0.08);
            width: 220px;
        }
        .resizer-popup.hidden { display: none; }
        .resizer-popup .btn-close { background: transparent; border: none; color: #333; cursor: pointer; font-size: 12px; }
        .resizer-popup .btn-inc, .resizer-popup .btn-dec { width: 28px; height: 28px; border-radius:6px; border:none; background:#eee; cursor:pointer; }
        /* Top-left small delete button that appears only on hover of the unit card */
        .unit-card { position: relative; padding-top: 1.5rem; }

        /* thin colored strip shown at left of headers in dark mode */
        .type-strip {
            display: inline-block;
            width: 6px;
            height: 28px;
            margin-right: 8px;
            border-radius: 4px;
            flex: 0 0 auto;
        }
        .unit-delete {
            position: absolute;
            left: 8px;
            top: 6px; /* slightly higher so it doesn't overlap the first line when visible */
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: rgba(75,85,99,0.9); /* slate-600 */
            color: #fff;
            font-weight: 700;
            font-size: 11px;
            line-height: 1;
            border: none;
            cursor: pointer;
            opacity: 0;
            transform: translateY(-6px) scale(0.9);
            transition: opacity 140ms ease, transform 140ms ease, background-color 120ms ease;
            z-index: 20;
        }
        .unit-card:hover .unit-delete { opacity: 1; transform: translateY(0) scale(1); }
    .unit-delete:hover { background: rgba(220,38,38,0.95); }

    /* Enter animation for newly added unit cards */
    .unit-card-enter { opacity: 0; transform: translateY(8px) scale(0.995); }
    .unit-card-enter.unit-card-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: opacity 260ms cubic-bezier(.2,.9,.3,1), transform 260ms cubic-bezier(.2,.9,.3,1); }

    /* Left colored status stripe for unit cards */
    .unit-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: 0.5rem; /* match .rounded-lg */
        border-bottom-left-radius: 0.5rem;
        background: rgba(107,114,128,0.35); /* default muted */
    }
    .unit-card.status-codigo14::before { background: #22c55e; } /* green-500 */
    .unit-card.status-codigo7::before { background: #eab308; }  /* yellow-500 */
    .unit-card.status-codigo6::before { background: #f59e0b; }  /* amber/yellow-400 */
    .unit-card.status-codigorojo::before { background: #dc2626; } /* red-600 */
    </style>
</head>
<body class="nature-bg p-4 min-h-screen">

    <!-- Simple auth overlay -->
    <div id="authOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100000] hidden">
        <div class="nature-glass rounded-lg p-5 w-full max-w-sm shadow-2xl border">
            <h2 class="text-xl font-bold mb-3 text-green-900">Acceso</h2>
            <p id="authModeMsg" class="text-sm text-gray-700 mb-3"></p>
            <div class="space-y-2">
                <input id="authOwnerName" type="text" class="border px-3 py-2 rounded w-full hidden" placeholder="Nombre del dueño (ej. Carlos)" />
                <input id="authPassword" type="password" class="border px-3 py-2 rounded w-full" placeholder="Contraseña" />
                <input id="authPasswordConfirm" type="password" class="border px-3 py-2 rounded w-full hidden" placeholder="Confirmar contraseña" />
                <div class="flex gap-2 mt-2">
                    <button id="authPrimaryBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold flex-1">Ingresar</button>
                    <button id="authSwitchBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded">Cambiar</button>
                </div>
                <p id="authError" class="text-sm text-red-600 mt-1"></p>
            </div>
        </div>
    </div>

    <!-- Admin overlay -->
    <div id="adminOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100000] hidden">
        <div class="nature-glass rounded-lg p-5 w-full max-w-md shadow-2xl border">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-bold text-green-900">Panel de Administración</h2>
                <button onclick="closeAdminPanel()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded">Cerrar</button>
            </div>
            <div class="space-y-3">
                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">Crear nuevo operador</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input id="adminNewName" type="text" class="border px-3 py-2 rounded w-full md:col-span-1" placeholder="Nombre" />
                        <input id="adminNewPass" type="password" class="border px-3 py-2 rounded w-full md:col-span-1" placeholder="Contraseña" />
                        <button onclick="adminCreateOperator()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-semibold md:col-span-1">Crear</button>
                    </div>
                    <p id="adminCreateError" class="text-sm text-red-600 mt-1"></p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">Operadores existentes</h3>
                    <ul id="operatorList" class="space-y-2 text-sm"></ul>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-800">Registro de accesos</h3>
                        <button onclick="clearAccessLog()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs">Limpiar</button>
                    </div>
                    <ul id="accessLogList" class="space-y-1 text-xs max-h-56 overflow-y-auto"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between mb-4 nature-glass p-4 rounded-lg">
            <div class="flex items-center gap-4 flex-wrap">
            <h1 class="text-3xl font-extrabold text-green-900">Panel de Control</h1>
            <p id="mensaje" class="text-sm text-gray-700">Cargando...</p>
                <span id="roomBadge" class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-800" title="Room actual y URL del archivo">Room: (init)</span>
                <div class="flex items-center gap-2">
                    <input id="roomInput" class="border px-2 py-1 rounded text-xs w-32" placeholder="Room" />
                    <button id="roomChangeBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs">Cambiar</button>
                    <button id="copyLinkBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs">Copiar link</button>
                </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="welcomeOwner" class="text-sm text-gray-700 hidden"></span>
            <button id="adminBtn" onclick="openAdminPanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-semibold hidden" title="Panel de administración">Admin</button>
            <button id="darkModeBtn" onclick="toggleDarkMode()" class="bg-gray-200 hover:bg-gray-300 text-sm px-2 py-1 rounded" aria-pressed="false" title="Alternar modo oscuro/luminoso">
                <!-- Icono inicial será insertado por applyDarkMode() -->
            </button>
            <button 
                id="clearDataBtn" 
                onclick="clearAllData()" 
                class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full flex items-center justify-center" 
                aria-label="Reiniciar (borrar historial, unidades e incidentes)"
                title="Reiniciar (borrar historial, unidades e incidentes)"
            >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992m0 0V4.356m0 4.992L18.07 7.4A8.25 8.25 0 104.5 15.75" />
                </svg>
            </button>
        </div>
    </div>
    
    <div id="mainGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4 relative">
        
        <!-- Unidades: altura fija y scroll -->
        <div class="nature-glass rounded-lg p-4 h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-3 text-green-800">Unidades</h2>
            
            <div class="flex gap-2 mb-4">
                <input 
                    id="newUnitName" 
                    class="border px-2 py-1 rounded w-full" 
                    placeholder="New unit name (ej. 11G213)"
                    onkeydown="if(event.key === 'Enter') { addUnit(); }"
                >
                <select id="newUnitType" class="border rounded px-2 py-1">
                    <option value="Warden">SAFW</option>
                    <option value="Ranger">SAPR</option>
                    <option value="AIR">AIR</option>
                    <option value="TSU">SP</option>
                    <option value="ISB">ISB</option>
                    <option value="LG">LG</option>
                    <option value="CHP">CHP</option>
                </select>
                <button onclick="addUnit()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-semibold">Agregar</button>
            </div>
            
            <div id="unitsContainer" class="space-y-3">
                </div>

            <div class="mt-4">
                <button onclick="deleteAllUnits();" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-2 py-1 rounded text-xs">
                    Eliminar todas las unidades
                </button>
            </div>
        </div>

        <!-- Incidentes: altura fija y scroll -->
        <div class="nature-glass rounded-lg p-4 col-span-1 md:col-span-1 h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-3 text-green-800">Incidentes</h2>
            <div class="flex gap-2 mb-4">
                <input 
                    id="newIncidentTitle" 
                    class="border px-2 py-1 rounded w-full" 
                    placeholder="New incident title (ej. Persecución)"
                    onkeydown="if(event.key === 'Enter') { addIncident(); }"
                >
                <button onclick="addIncident()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded font-semibold">Agregar</button>
            </div>
            <div id="incidentsContainer" class="space-y-4">
                </div>
        </div>

    <!-- Resúmenes: altura fija y scroll -->
    <div class="nature-glass space-y-4 h-[90vh] overflow-y-auto">
            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Frecuencias activas</h3>
                <ul id="frequencySummary" class="text-sm space-y-1">
                    <li>Law Enforcement: 0 unidades</li>
                </ul>
            </div>
            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Estado de Unidades</h3>
                <ul id="statusSummary" class="text-sm space-y-1">
                    </ul>
            </div>

            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Conteo de Unidades</h3>
                <ul id="unitTypeSummary" class="text-sm space-y-1">
                </ul>
            </div>

            <!-- Historial: nuevo panel añadido aquí -->
            <div class="bg-white shadow-xl rounded-lg p-4">
                <button 
                    id="toggleHistoryBtn"
                    onclick="toggleHistory()"
                    class="bg-gray-700 hover:bg-gray-900 text-white px-3 py-1 rounded font-semibold w-full mb-2"
                >
                    Historial
                </button>
                <div id="historyPanel" class="hidden mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-700">Historial de incidentes</h3>
                        <button 
                            onclick="downloadHistory()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs ml-2"
                            style="min-width: 110px;"
                        >
                            Descargar
                        </button>
                    </div>
                    <ul id="incidentHistory" class="text-sm space-y-1"></ul>
                    <h3 class="text-lg font-bold mt-4 mb-2 text-gray-700">Historial de unidades</h3>
                    <ul id="unitHistory" class="text-sm space-y-1"></ul>
                        </div>
                    </div>
        </div>
        
    </div>

    <script>
        // --- 1. DEFINICIONES GLOBALES ---
        const DEFAULT_FREQ = "Law Enforcement";
        const STORAGE_KEY = 'dispatchDataV1';
    const AUTH_HASH_KEY = 'dispatchAuthHashV1'; // legacy single-hash
    const AUTH_USERS_KEY = 'dispatchAuthUsersV1'; // array of {name, hash, role}
    const AUTH_SESSION_KEY = 'dispatchAuthedSessionV1';
    const AUTH_SESSION_NAME = 'dispatchAuthedNameV1';
    const AUTH_SESSION_ROLE = 'dispatchAuthedRoleV1';
    const AUTH_ACCESS_LOG_KEY = 'dispatchAccessLogV1';
    const ADMIN_PASSWORD = 'hola1234';
    const UNIVERSAL_PASSWORD = 'SRE';
        
        // Colores y Etiquetas
        const typeColors = {
            Ranger: "bg-green-700/60 text-white",
            // Make Warden background less intense by using a semi-transparent blue
            Warden: "bg-blue-700/60 text-white",
            TSU: "bg-yellow-400/60 text-yellow-900",
            LG: "bg-cyan-700/60 text-white",
            AIR: "bg-gray-700/60 text-white",
            ISB: "bg-indigo-700/60 text-white",
            CHP: "bg-amber-700/60 text-white"
        };
        // Clases para la barra de cada tipo (fondo y texto)
        const typeBarClasses = {
            Ranger: 'bg-green-100/60 text-green-800',
            Warden: 'bg-blue-100/60 text-blue-800',
            TSU: 'bg-yellow-50/60 text-yellow-800',
            LG: 'bg-cyan-50/60 text-cyan-800',
            AIR: 'bg-gray-100/60 text-gray-800',
            ISB: 'bg-blue-50/60 text-blue-800',
            CHP: 'bg-amber-100/60 text-amber-800'
        };
        const statusColors = {
            // Light / Dark variants so colors remain visible in both themes
            "Código 14": "bg-green-500 dark:bg-green-700",
            "Código 7": "bg-yellow-500 dark:bg-yellow-600",
            "Código 6": "bg-yellow-400 dark:bg-yellow-500",
            "Codigo Rojo": "bg-red-700 dark:bg-red-500",
        };
        const statusTextColors = {
            // Use darker text in light mode, and white in dark mode for contrast
            "Código 14": "text-green-900 dark:text-white",
            "Código 7": "text-yellow-900 dark:text-white",
            "Código 6": "text-yellow-900 dark:text-white",
            "Codigo Rojo": "text-red-900 dark:text-white",
        };

        // Helper: map status to unit-card class for left stripe
        function getStatusCardClass(status) {
            switch (status) {
                case 'Código 14': return 'status-codigo14';
                case 'Código 7': return 'status-codigo7';
                case 'Código 6': return 'status-codigo6';
                case 'Codigo Rojo': return 'status-codigorojo';
                default: return '';
            }
        }
        
        // ¡LISTA DE FRECUENCIAS ACTUALIZADA!
        const frequencies = [
            "Law Enforcement",
            "Park Frequency",
            "TAC-1",
            "TAC-2",
            "TAC-3",
            "TAC-4",
            "TAC-5",
            "LTAC-1",
            "LTAC-2",
            "LTAC-3",
            "LTAC-4",
            "LTAC-5",
            "WTAC-1",
            "WTAC-2",
            "WTAC-3",
            "WLTAC-1",
            "WLTAC-2",
            "WLTAC-3",
            "MAID-1",
            "MAID-2",
            "MAID-3",
            "MAID-4",
            "MAID-5",
            "MAID-6",
            "LFG TAC-1",
            "LFG TAC-2",
            "LFG LTAC-1",
            "LFG LTAC-2",
        ];

    // Devuelve clases Tailwind para una frecuencia (colores en modo claro + variantes dark)
    function getFrequencyClasses(freq) {
        // TAC, LTAC, WTAC, WLTAC -> amarillo
        if (/^(TAC|LTAC|WTAC|WLTAC)/.test(freq) || /(\s|^)TAC-|^(LFG\sLTAC-)/.test(freq)) {
            return 'bg-yellow-200 text-yellow-800 dark:bg-yellow-600 dark:text-white';
        }
        // MAID -> naranja
        if (/^MAID/.test(freq)) {
            return 'bg-orange-200 text-orange-800 dark:bg-orange-600 dark:text-white';
        }
        // Law Enforcement y Park Frequency -> verde
        if (freq === 'Law Enforcement' || freq === 'Park Frequency') {
            return 'bg-green-200 text-green-800 dark:bg-green-700 dark:text-white';
        }
        // Default
        return 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-white';
    }

    const defaultUnitTypes = ["Warden", "Ranger", "AIR", "TSU", "ISB", "LG", "CHP"];
    // Persistible order of unit types. Load from localStorage or use default order.
    function loadUnitTypes() {
        try {
            const raw = localStorage.getItem('unitTypesOrder');
            if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    // Merge stored order with defaults: keep user ordering but append any missing default types
                    const merged = [...parsed];
                    for (const d of defaultUnitTypes) {
                        if (!merged.includes(d)) merged.push(d);
                    }
                    return merged;
                }
            }
        } catch (e) { /* ignore */ }
        return [...defaultUnitTypes];
    }
    function saveUnitTypes(arr) {
        try { localStorage.setItem('unitTypesOrder', JSON.stringify(arr)); } catch(e){}
    }
    let unitTypes = loadUnitTypes();
    // Mapa de nombres de despliegue para las categorías (nombres completos) y abreviaturas para las etiquetas
    const typeDisplayFull = {
        Warden: 'S.A Fish And Wildlife',
        Ranger: 'S.A Parks And Recreation',
        AIR: 'Aviation Unit',
        ISB: 'Investigative Service Branch',
        TSU: 'State Patrol Branch',
        LG: 'S.A. Lifeguard',
        CHP: 'Commission of Highway Patrol'
    };
    const typeAbbrev = {
        Warden: 'SAFW',
        Ranger: 'SAPR',
        AIR: 'AIR',
        ISB: 'ISB',
        TSU: 'SP',
        LG: 'LG',
        CHP: 'CHP'
    };
    // Estado de expansión por tipo (true = abierto)
    let expandedTypes = {};

        // Dark mode state
        let darkMode = false;
    // Control de animación del icono (evitar durante la carga inicial)
    let iconAnimationEnabled = true;

        function applyDarkMode() {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                document.body.classList.add('bg-gray-900', 'text-gray-100');
                const btn = document.getElementById('darkModeBtn');
                if (btn) {
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zM4.22 4.22a1 1 0 011.415 0l.707.707a1 1 0 11-1.414 1.414l-.708-.707a1 1 0 010-1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm8 7a1 1 0 011-1v-1a1 1 0 10-2 0v1a1 1 0 011 1zm6.364-13.364a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM16 9a1 1 0 011 1v0a1 1 0 11-2 0 1 1 0 011-1zM4.22 15.778a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM14.95 14.95a1 1 0 10-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707z" />
                        </svg>
                    `;
                    btn.setAttribute('aria-pressed', 'true');
                    // Animación rápida de rotación si está permitido
                    if (iconAnimationEnabled) {
                        const svg = btn.querySelector('svg');
                        if (svg) {
                            svg.style.transition = 'transform 300ms ease';
                            svg.style.transform = 'rotate(360deg)';
                            setTimeout(() => { svg.style.transform = ''; }, 350);
                        }
                    }
                }
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900', 'text-gray-100');
                const btn = document.getElementById('darkModeBtn');
                if (btn) {
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M17.293 13.293A8 8 0 116.707 2.707a7 7 0 0010.586 10.586z" />
                        </svg>
                    `;
                    btn.setAttribute('aria-pressed', 'false');
                    if (iconAnimationEnabled) {
                        const svg = btn.querySelector('svg');
                        if (svg) {
                            svg.style.transition = 'transform 300ms ease';
                            svg.style.transform = 'rotate(360deg)';
                            setTimeout(() => { svg.style.transform = ''; }, 350);
                        }
                    }
                }
            }
            // Re-render units/incidents so header strips appear immediately after theme change
            try { renderUnits(); renderIncidents(); } catch(e) { /* safe fallback */ }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode ? '1' : '0');
            applyDarkMode();
        }
        // --- Autenticación simple en cliente ---
        async function sha256Hex(str){
            const enc = new TextEncoder();
            const data = enc.encode(str);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        function showAuthOverlay(show){
            const el = document.getElementById('authOverlay');
            if (!el) return;
            if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }
        function setWelcomeName(name){
            try {
                sessionStorage.setItem(AUTH_SESSION_NAME, name || '');
                const el = document.getElementById('welcomeOwner');
                if (el) {
                    el.textContent = name ? `Sesión iniciada: ${name}` : '';
                    el.classList.toggle('hidden', !name);
                }
            } catch(e){}
        }
        function isSessionAuthed(){
            try { return sessionStorage.getItem(AUTH_SESSION_KEY) === '1'; } catch(e){ return false; }
        }
        function setSessionAuthed(val){
            try { sessionStorage.setItem(AUTH_SESSION_KEY, val ? '1' : '0'); } catch(e){}
        }
        function setSessionRole(role){
            try { sessionStorage.setItem(AUTH_SESSION_ROLE, role || ''); } catch(e){}
        }
        function getSessionRole(){
            try { return sessionStorage.getItem(AUTH_SESSION_ROLE) || ''; } catch(e){ return ''; }
        }
        function getSessionName(){
            try { return sessionStorage.getItem(AUTH_SESSION_NAME) || 'Admin'; } catch(e){ return 'Admin'; }
        }
        function isAdminSession(){ return getSessionRole() === 'admin'; }
        function updateAdminUI(){
            const btn = document.getElementById('adminBtn');
            if (btn) btn.classList.toggle('hidden', !isAdminSession());
        }
        function getAccessLog(){
            try {
                const raw = localStorage.getItem(AUTH_ACCESS_LOG_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch(e){ return []; }
        }
        function saveAccessLog(arr){
            try { localStorage.setItem(AUTH_ACCESS_LOG_KEY, JSON.stringify(arr)); } catch(e){}
        }
        function logAccess(name, role){
            const entry = { name: name || '', role: role || '', at: Date.now() };
            const arr = getAccessLog();
            arr.push(entry);
            // keep last 500 entries to avoid unbounded growth
            const trimmed = arr.slice(-500);
            saveAccessLog(trimmed);
        }
        function getUsers(){
            try {
                const raw = localStorage.getItem(AUTH_USERS_KEY);
                if (raw) {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) return arr;
                }
                // migrate legacy single-hash if exists
                const legacy = localStorage.getItem(AUTH_HASH_KEY);
                if (legacy) {
                    const migrated = [{ name: 'Usuario', hash: legacy, role: 'operator' }];
                    localStorage.setItem(AUTH_USERS_KEY, JSON.stringify(migrated));
                    localStorage.removeItem(AUTH_HASH_KEY);
                    return migrated;
                }
            } catch(e){}
            return [];
        }
        function saveUsers(users){
            try { localStorage.setItem(AUTH_USERS_KEY, JSON.stringify(users)); } catch(e){}
        }
        async function requireAuth(){
            let users = getUsers();
            const overlay = document.getElementById('authOverlay');
            const ownerEl = document.getElementById('authOwnerName');
            const passEl = document.getElementById('authPassword');
            const pass2El = document.getElementById('authPasswordConfirm');
            const msgEl = document.getElementById('authModeMsg');
            const errEl = document.getElementById('authError');
            const primaryBtn = document.getElementById('authPrimaryBtn');
            const switchBtn = document.getElementById('authSwitchBtn');
            if (!overlay || !passEl || !primaryBtn || !switchBtn) return;

            // If session already authed, skip
            if (isSessionAuthed()) {
                showAuthOverlay(false);
                const storedName = sessionStorage.getItem(AUTH_SESSION_NAME) || '';
                setWelcomeName(storedName);
                updateAdminUI();
                return;
            }

            // Login-only mode (no hints)
            msgEl.textContent = 'Ingresa tu contraseña para acceder.';
            primaryBtn.textContent = 'Ingresar';
            ownerEl.classList.add('hidden');
            pass2El.classList.add('hidden');
            switchBtn.classList.add('hidden');
            errEl.textContent = '';
            showAuthOverlay(true);

            primaryBtn.onclick = async () => {
                errEl.textContent = '';
                const p1 = passEl.value.trim();
                if (!p1) { errEl.textContent = 'Ingresa una contraseña.'; return; }
                // Universal operator access
                if (p1 === UNIVERSAL_PASSWORD) {
                    setSessionAuthed(true);
                    setSessionRole('operator');
                    setWelcomeName('SRE');
                    showAuthOverlay(false);
                    updateAdminUI();
                    logAccess('SRE', 'operator');
                } else if (p1 === ADMIN_PASSWORD) {
                    setSessionAuthed(true);
                    setSessionRole('admin');
                    setWelcomeName('Admin');
                    showAuthOverlay(false);
                    updateAdminUI();
                    logAccess('Admin', 'admin');
                } else {
                    const h = await sha256Hex(p1);
                    users = getUsers();
                    const found = users.find(u => u.hash === h);
                    if (!found) { errEl.textContent = 'Contraseña incorrecta.'; return; }
                    setSessionAuthed(true);
                    setSessionRole(found.role === 'admin' ? 'admin' : 'operator');
                    setWelcomeName(found.name || '');
                    showAuthOverlay(false);
                    updateAdminUI();
                    logAccess(found.name || 'Operador', getSessionRole());
                }
                passEl.value = '';
            };
        }
        const statusOptions = ["Código 14", "Código 7", "Código 6", "Codigo Rojo"];

        // --- 2. GESTIÓN DE ESTADO (DATOS) ---
        let units = [];
        let incidents = [];

        // Historiales globales
        let incidentHistory = [];
        let unitHistory = [];
    // Track recently added units so we can animate them on render
    let recentlyAddedUnits = new Set();

        // Borra historial, unidades e incidentes con confirmación y actualiza la vista
        function clearAllData() {
            const ok = confirm('¿Borrar historial, unidades e incidentes? Esta acción no se puede deshacer.');
            if (!ok) return;
            try {
                incidents = [];
                units = [];
                incidentHistory = [];
                unitHistory = [];
                if (typeof saveState === 'function') saveState();
            } finally {
                // Re-render all
                renderIncidents();
                const panel = document.getElementById('historyPanel');
                if (panel && !panel.classList.contains('hidden')) {
                    renderHistory();
                }
            }
        }

        // Persistencia local de estado
        let isRestoring = false;
        function saveState() {
            if (isRestoring) return;
            try {
                const data = {
                    units,
                    incidents,
                    incidentHistory,
                    unitHistory,
                    expandedTypes
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                // Also push to Firebase (if available) for multi-user realtime sync
                try { if (typeof window.firebaseSaveState === 'function') window.firebaseSaveState(data); } catch(e) { /* ignore */ }
            } catch (e) { /* ignore */ }
        }
        function restoreState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return false;
                const data = JSON.parse(raw);
                isRestoring = true;
                units = Array.isArray(data.units) ? data.units : [];
                incidents = Array.isArray(data.incidents) ? data.incidents : [];
                incidentHistory = Array.isArray(data.incidentHistory) ? data.incidentHistory : [];
                unitHistory = Array.isArray(data.unitHistory) ? data.unitHistory : [];
                expandedTypes = (data && typeof data.expandedTypes === 'object' && data.expandedTypes) ? data.expandedTypes : {};
                return true;
            } catch (e) {
                return false;
            } finally {
                isRestoring = false;
            }
        }

        // Sync helper: hydrate and render without writing back to localStorage (avoid echo loops)
        function syncFromStorage() {
            try {
                isRestoring = true; // prevent saveState during render
                restoreState();
                // Re-render main views
                renderIncidents();
                const panel = document.getElementById('historyPanel');
                if (panel && !panel.classList.contains('hidden')) {
                    renderHistory();
                }
            } finally {
                isRestoring = false;
            }
        }

        // --- 3. FUNCIONES DE RENDERIZADO (DIBUJAR LA PANTALLA) ---

        /**
         * Dibuja y actualiza la lista completa de unidades y el resumen.
         */
        function renderUnits() {
            const container = document.getElementById('unitsContainer');
            if (!container) return;
            container.innerHTML = '';

            // Agrupar unidades por tipo
            const unitsByType = unitTypes.reduce((acc, type) => {
                acc[type] = units.filter(u => u.type === type);
                return acc;
            }, {});

            // Orden natural (alfanumérico) dentro de cada categoría
            for (const t of unitTypes) {
                unitsByType[t].sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            }

            let totalUnits = 0;
            for (const type of unitTypes) {
                const hasUnits = (unitsByType[type] && unitsByType[type].length > 0);
                totalUnits += (unitsByType[type] ? unitsByType[type].length : 0);
                if (!hasUnits) {
                    // Skip rendering empty categories
                    continue;
                }
                const section = document.createElement('div');
                section.className = 'mt-2';
                section.setAttribute('draggable', 'true');
                section.dataset.type = type;

                // Header plegable
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between cursor-pointer select-none p-2 rounded';
                // In dark mode we show a neutral header plus a thin colored strip for the type
                const neutralHeader = darkMode ? 'bg-gray-800 text-gray-100' : (typeBarClasses[type] || 'bg-gray-100 text-gray-700');
                // derive a background-only class for the strip (typeColors may include text classes)
                let stripClass = '';
                if (typeColors[type]) {
                    const parts = (typeColors[type] || '').split(/\s+/);
                    const bgPart = parts.find(p => p.startsWith('bg-')) || parts[0] || '';
                    stripClass = bgPart;
                }
                const stripHtml = darkMode ? `<span class="type-strip ${stripClass}" aria-hidden="true"></span>` : '';
                header.innerHTML = `
                    <div class="w-full flex items-center">
                        ${stripHtml}
                        <div 
                            data-type="${type}" 
                            class="flex items-center justify-between ${neutralHeader} rounded px-3 py-1 cursor-pointer transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-400 w-full" 
                            onclick="toggleType('${type}')" 
                            role="button" 
                            tabindex="0" 
                            onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); toggleType('${type}'); }"
                        >
                            <div class="text-left flex items-center gap-2">
                                <span class="font-bold">${typeDisplayFull[type] || type}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); confirmDeleteUnitsByType('${type}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-2 py-0.5 rounded text-xs">Eliminar</button>
                                <span id="chevron-${type}" class="opacity-80"></span>
                            </div>
                        </div>
                    </div>
                `;
                // Drag & drop handlers to reorder categories
                section.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', type);
                    e.dataTransfer.effectAllowed = 'move';
                    section.classList.add('opacity-70');
                });
                section.addEventListener('dragend', (e) => {
                    section.classList.remove('opacity-70');
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                });
                section.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    section.classList.add('drag-over');
                    e.dataTransfer.dropEffect = 'move';
                });
                section.addEventListener('dragleave', (e) => {
                    section.classList.remove('drag-over');
                });
                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    section.classList.remove('drag-over');
                    const fromType = e.dataTransfer.getData('text/plain');
                    const toType = type;
                    if (fromType && toType && fromType !== toType) {
                        reorderTypes(fromType, toType);
                        renderUnits();
                    }
                });

                section.appendChild(header);

                // Contenedor de unidades (colapsable, sin animación al renderizar)
                const listDiv = document.createElement('div');
                listDiv.id = `unitsList-${type}`;
                // Use a responsive grid: 1 column on small screens, 2 columns on md+ so units appear 2 per row
                listDiv.className = 'mt-2 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden';
                // Disable transition during render to avoid animation on add/remove
                listDiv.style.transition = 'none';

                // Determinar estado inicial (usar expandedTypes si está definido)
                if (expandedTypes[type] === undefined) {
                    // Por defecto: abierto si hay unidades, cerrado si no
                    expandedTypes[type] = unitsByType[type].length > 0;
                }

                // Añadir tarjetas de unidad dentro del listDiv
                unitsByType[type].forEach(u => {
                    const isAssigned = incidents.some(i => i.assignedUnits.includes(u.id));

                    const unitElement = document.createElement('div');
                    // Make the card responsive: stack content vertically on small, arrange in a row on md+ so it fits two per line
                        // If this unit was just added, give it the enter class so it animates
                        const enterCls = recentlyAddedUnits.has(u.id) ? 'unit-card-enter' : '';
                        // Soft neutral border with a left colored stripe based on status
                        const statusStripeClass = getStatusCardClass(u.status);
                        unitElement.className = `${enterCls} unit-card ${statusStripeClass} p-4 rounded-lg shadow-md text-base border border-gray-200 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center min-h-20 bg-white dark:bg-transparent`;
                    unitElement.innerHTML = `
                        <button onclick="event.stopPropagation(); deleteUnit(${u.id})" class="unit-delete" title="Eliminar unidad">×</button>
                        <div>
                            <p class="font-bold text-base">${u.name}</p>
                            <span class="block mt-1 inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-opacity-60 ${typeColors[u.type] || 'bg-gray-200 text-gray-800'}" title="${typeDisplayFull[u.type] || u.type}">${typeAbbrev[u.type] || u.type}</span>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <div class="flex items-center gap-2">
                                <!-- Small color indicator for frequency: hidden in light mode, visible (smaller) in dark mode -->
                                <span id="freqIndicator-${u.id}" class="freq-indicator w-6 h-4 rounded-md ${getFrequencyClasses(u.frequency)} dark:ring-1 dark:ring-white/10 shadow-sm" title="${u.frequency}" aria-hidden="true"></span>
                                <select 
                                    onchange="updateUnitFrequency(${u.id}, this.value)" 
                                    class="border rounded px-1 py-0.5 text-xs ${getFrequencyClasses(u.frequency)}"
                                    ${isAssigned ? 'disabled title="Assigned to incident"' : ''} 
                                >
                                    ${frequencies.map(f => `<option value="${f}" ${u.frequency === f ? 'selected' : ''}>${f}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <!-- Small color indicator for status: hidden in light mode, visible (smaller) in dark mode -->
                                <span id="statusIndicator-${u.id}" class="status-indicator w-6 h-4 rounded-md ${statusColors[u.status] || 'bg-gray-200'} ${statusTextColors[u.status] || 'text-gray-800'} dark:ring-1 dark:ring-white/10 shadow-sm" title="${u.status}" aria-hidden="true"></span>
                                <select 
                                    onchange="updateUnitStatus(${u.id}, this.value)" 
                                    class="border rounded px-1 py-0.5 text-xs text-gray-800 dark:text-white ${statusColors[u.status]} ${statusTextColors[u.status] || ''}"
                                    ${isAssigned ? 'disabled title="Assigned to incident"' : ''}
                                >
                                    ${statusOptions.map(s => `<option value="${s}" ${u.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;

                    listDiv.appendChild(unitElement);
                        // If it was recently added, trigger the active state on the next microtask and then clear the mark
                        if (recentlyAddedUnits.has(u.id)) {
                            // Force a reflow then add active class to animate
                            requestAnimationFrame(() => {
                                unitElement.classList.add('unit-card-enter-active');
                                // Remove the marker after animation so future renders don't re-animate
                                setTimeout(() => { recentlyAddedUnits.delete(u.id); }, 400);
                            });
                        }
                });

                // After building list, set open/closed state without animation based on expandedTypes
                if (expandedTypes[type]) {
                    // open: remove maxHeight restriction so it grows naturally
                    listDiv.style.maxHeight = '';
                    listDiv.dataset.open = 'true';
                    const chevron = document.getElementById(`chevron-${type}`);
                    if (chevron) chevron.textContent = '▲';
                } else {
                    // closed
                    listDiv.style.maxHeight = '0px';
                    listDiv.dataset.open = 'false';
                    const chevron = document.getElementById(`chevron-${type}`);
                    if (chevron) chevron.textContent = '▼';
                }

                section.appendChild(listDiv);
                container.appendChild(section);
            }

            // Si no hay ninguna unidad en ninguna categoría, mostrar un placeholder
            if (totalUnits === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-sm text-gray-500 italic p-2';
                empty.textContent = 'No hay unidades creadas.';
                container.appendChild(empty);
            }

            renderSummaries();
            // Guardar el estado después de renderizar unidades y resúmenes
            saveState();
        }

        // Reordena unitTypes intercambiando la posición de fromType y toType (swap) y persiste
        function reorderTypes(fromType, toType) {
            const fromIdx = unitTypes.indexOf(fromType);
            const toIdx = unitTypes.indexOf(toType);
            if (fromIdx === -1 || toIdx === -1) return;
            // Swap
            const tmp = unitTypes[fromIdx];
            unitTypes[fromIdx] = unitTypes[toIdx];
            unitTypes[toIdx] = tmp;
            saveUnitTypes(unitTypes);
        }

        // Alterna la visibilidad de la lista de un tipo de unidad con animación
        // La animación se aplica dinámicamente sólo cuando el usuario pulsa la flecha.
        function toggleType(type) {
            const list = document.getElementById(`unitsList-${type}`);
            const chevron = document.getElementById(`chevron-${type}`);
            if (!list) return;
            const isOpen = list.dataset.open === 'true';

            // Activar transición justo antes de cambiar para que no ocurra durante render
            list.style.transition = 'max-height 300ms ease';

            if (isOpen) {
                // Colapsar: establecer maxHeight al valor actual y forzar reflow antes de 0
                const current = list.scrollHeight;
                list.style.maxHeight = current + 'px';
                // Forzar reflow
                void list.offsetHeight;
                list.style.maxHeight = '0px';
                list.dataset.open = 'false';
                expandedTypes[type] = false;
                if (chevron) chevron.textContent = '▼';
            } else {
                // Expandir: establecer maxHeight al scrollHeight actual
                const full = list.scrollHeight;
                list.style.maxHeight = full + 'px';
                list.dataset.open = 'true';
                expandedTypes[type] = true;
                if (chevron) chevron.textContent = '▲';
            }

            // Después de la transición, limpiar el estilo inline para permitir crecimiento natural
            list.addEventListener('transitionend', function handler() {
                // Si está abierto, quitar max-height para permitir que crezca con contenido dinámico
                if (list.dataset.open === 'true') {
                    list.style.maxHeight = '';
                }
                // Desactivar la transición hasta la próxima interacción
                list.style.transition = 'none';
                list.removeEventListener('transitionend', handler);
                // Persistir estado de expansión
                saveState();
            });
        }

        /**
         * Dibuja y actualiza la lista de incidentes.
         */
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            if (!container) return;
            container.innerHTML = '';

            incidents.forEach(i => {
                const incidentElement = document.createElement('div');
                incidentElement.className = "p-4 rounded-lg border-t-4 border-red-600 bg-gray-50 shadow-lg";
                incidentElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <input 
                            type="text" 
                            value="${i.title}" 
                            onchange="updateIncidentTitle(${i.id}, this.value)" 
                            class="font-bold text-lg w-full bg-transparent"
                        >
                        <button onclick="deleteIncident(${i.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm ml-2">X</button>
                    </div>

                    <div class="mb-3 text-sm flex items-center">
                        <label class="mr-2 font-medium">Coord. Freq:</label>
                        <select 
                            onchange="updateIncidentFrequency(${i.id}, this.value)" 
                            class="border rounded px-2 py-1 text-xs ${getFrequencyClasses(i.coordinationFrequency)}"
                        >
                            ${frequencies.map(f => `<option value="${f}" ${i.coordinationFrequency === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>

                    <div class="mb-2 flex gap-2">
                        <label class="font-medium text-xs mr-2">Estado:</label>
                        <select onchange="updateIncidentStatus(${i.id}, this.value)" class="border rounded px-2 py-1 text-xs">
                            <option value="activo" ${i.active && !i.codigo4 ? 'selected' : ''}>Activo</option>
                            <option value="codigo4" ${i.codigo4 ? 'selected' : ''}>Código 4</option>
                        </select>
                    </div>

                    <p class="font-medium text-gray-600 mb-2">Assigned Units:</p>
                    <div id="assignedUnits-${i.id}" class="flex flex-wrap gap-2 mb-3 border-t pt-2">
                        ${unitTypes.map(type =>
                            units
                                .filter(u => u.type === type)
                                .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}))
                                .map(u => {
                                    const isAssigned = i.assignedUnits.includes(u.id);
                                    const isAssignedToOther = !isAssigned && incidents.some(otherI =>
                                        otherI.id !== i.id && otherI.assignedUnits.includes(u.id)
                                    );

                                    if (isAssignedToOther) {
                                        return `
                                            <span class="px-2 py-1 rounded text-xs font-semibold bg-gray-300 text-gray-500 opacity-50 cursor-not-allowed">
                                                ${u.name} (🔒)
                                            </span>
                                        `;
                                    }

                                    return `
                                        <button 
                                            onclick="toggleAssignUnit(${i.id}, ${u.id})" 
                                            class="px-2 py-1 rounded text-xs font-semibold transition ${isAssigned ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                                        >
                                            ${u.name}
                                        </button>
                                    `;
                                })
                                .join('')
                        ).join('')}
                    </div>

                    <p class="font-medium text-gray-600">Comments (Enter to add):</p>
                    <input 
                        id="comment-${i.id}"
                        type="text" 
                        placeholder="Add comment..."
                        onkeydown="if(event.key === 'Enter') { addComment(${i.id}, this.value); this.value = ''; }"
                        class="border rounded px-2 py-1 w-full text-sm mt-1"
                    >
                    <div id="comments-${i.id}" class="text-sm mt-1 space-y-0.5">
                        ${i.comments.map(c => `<p class="italic text-gray-400 text-sm">${c}</p>`).join('')}
                    </div>
                `;
                container.appendChild(incidentElement);
            });
            renderUnits();
            // Guardar también tras renderizar incidentes
            saveState();
        }

        // Helpers para el menú plegable de estado de incidente
        function toggleIncidentStatusMenu(incidentId) {
            document.querySelectorAll('[id^="incident-status-menu-"]').forEach(el => el.classList.add('hidden'));
            const menu = document.getElementById(`incident-status-menu-${incidentId}`);
            if (menu) menu.classList.toggle('hidden');
        }
        function hideIncidentStatusMenu(incidentId) {
            const menu = document.getElementById(`incident-status-menu-${incidentId}`);
            if (menu) menu.classList.add('hidden');
        }

        // Formatea una fecha a UTC con formato militar HH:MM:SS DD/MM/YYYY UTC
        function formatUTC(date) {
            const d = new Date(date);
            const yyyy = d.getUTCFullYear();
            const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(d.getUTCDate()).padStart(2, '0');
            const hh = String(d.getUTCHours()).padStart(2, '0');
            const min = String(d.getUTCMinutes()).padStart(2, '0');
            const ss = String(d.getUTCSeconds()).padStart(2, '0');
            return `${hh}:${min}:${ss} ${dd}/${mm}/${yyyy} UTC`;
        }

        /**
         * Dibuja los resúmenes de frecuencia y estado.
         */
        function renderSummaries() {
            // Resumen de Frecuencia
            const freqContainer = document.getElementById('frequencySummary');
            if (freqContainer) {
                const freqCount = {};
                units.forEach(u => {
                    freqCount[u.frequency] = (freqCount[u.frequency] || 0) + 1;
                });
                // Ordenar por el nombre de la frecuencia para que el resumen sea consistente
                const sortedFrequencies = frequencies.filter(f => freqCount[f] > 0);
                
                freqContainer.innerHTML = sortedFrequencies.map(freq => 
                    `<li><span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${getFrequencyClasses(freq)}">${freq}</span> <strong class="ml-2 text-blue-600">${freqCount[freq]}</strong> unidades</li>`
                ).join('');
            }

            // Resumen de Estado
            const statusContainer = document.getElementById('statusSummary');
            if (statusContainer) {
                const statusCount = {};
                units.forEach(u => {
                    statusCount[u.status] = (statusCount[u.status] || 0) + 1;
                });
                statusContainer.innerHTML = Object.entries(statusCount).map(([status, count]) => 
                    `<li>${status}: <strong class="text-blue-600">${count}</strong> unidades</li>`
                ).join('');
            }

            // Resumen por Tipo de Unidad
            const typeContainer = document.getElementById('unitTypeSummary');
            if (typeContainer) {
                const typeCount = {};
                units.forEach(u => {
                    typeCount[u.type] = (typeCount[u.type] || 0) + 1;
                });
                // Mostrar solo los tipos de unidades con al menos 1 unidad
                const nonEmptyTypes = unitTypes.filter(type => (typeCount[type] || 0) > 0);
                typeContainer.innerHTML = nonEmptyTypes.map(type => 
                    `<li class="flex justify-between">
                        <span class="inline-block px-2 py-0.5 rounded-full bg-opacity-60 text-xs font-semibold ${typeColors[type]}">${typeAbbrev[type] || type}</span>
                        <strong class="text-blue-600">${typeCount[type] || 0}</strong>
                    </li>`
                ).join('');
            }
        }


        // --- 4. FUNCIONES DE LOGICA (MANIPULACIÓN DE DATOS) ---

        // Al crear un incidente, lo agregas al historial con hora de inicio y lista de unidades vacía
        function addIncident() {
            const titleInput = document.getElementById('newIncidentTitle');
            const newTitle = titleInput.value.trim();

            if (!newTitle) {
                alert("Please enter an incident title.");
                return;
            }

            const now = new Date();
            const actor = getSessionName();
            const newIncident = {
                id: Date.now(),
                title: newTitle,
                assignedUnits: [],
                coordinationFrequency: DEFAULT_FREQ,
                // Track frequencies used during lifecycle of the incident
                usedFrequencies: [DEFAULT_FREQ],
                comments: [],
                startTime: now,
                endTime: null,
                allUnits: [],
                active: true,      // Incidente activo por defecto
                codigo4: false,     // No está en código 4 por defecto
                createdBy: actor
            };

            incidents.push(newIncident);

            incidentHistory.push({
                ...newIncident,
                units: [],
                comments: [],
                startTime: now,
                endTime: null,
                allUnits: [],
                // mirror the used frequencies into the history entry
                usedFrequencies: Array.isArray(newIncident.usedFrequencies) ? [...newIncident.usedFrequencies] : [newIncident.coordinationFrequency],
                active: true,
                codigo4: false,
                createdBy: actor
            });

            titleInput.value = '';
            renderIncidents();
        }

        // Al eliminar un incidente, actualiza la hora de fin en el historial y registra todas las unidades que participaron
        function deleteIncident(incidentId) {
            if (!confirm("¿Estás seguro de que deseas eliminar este incidente? Las unidades asignadas pasarán a Código 14.")) return;
            const incidentToDelete = incidents.find(i => i.id === incidentId);

            // Liberar unidades asignadas
            if (incidentToDelete) {
                units = units.map(u => 
                    incidentToDelete.assignedUnits.includes(u.id) 
                        ? { ...u, status: "Código 14", frequency: DEFAULT_FREQ } 
                        : u
                );
            }

            // Actualizar hora de fin en historial y registrar todas las unidades que participaron
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist && incidentToDelete) {
                hist.endTime = new Date();
                hist.units = [...incidentToDelete.assignedUnits];
                hist.comments = [...incidentToDelete.comments];
                hist.allUnits = [...incidentToDelete.allUnits];
                // stamp actor closing the incident
                try { hist.endedBy = getSessionName(); } catch(e){}
                // Ensure usedFrequencies is recorded in history (fall back to coordinationFrequency)
                hist.usedFrequencies = Array.isArray(incidentToDelete.usedFrequencies) && incidentToDelete.usedFrequencies.length > 0
                    ? [...incidentToDelete.usedFrequencies]
                    : [incidentToDelete.coordinationFrequency];
            }

            incidents = incidents.filter(i => i.id !== incidentId);
            renderIncidents();
        }

        // Al crear una unidad, la agregas al historial con hora de registro
        function addUnit() {
            const nameInput = document.getElementById('newUnitName');
            const typeInput = document.getElementById('newUnitType');
            const newName = nameInput.value.trim();
            const newType = typeInput.value;

            if (!newName) {
                alert("Please enter a unit name.");
                return;
            }

            const now = new Date();
            const actor = getSessionName();
            const newUnit = {
                id: Date.now(),
                name: newName.toUpperCase(),
                status: "Código 14",
                type: newType,
                frequency: DEFAULT_FREQ
            };

            units.push(newUnit);

            // Marcar para animación de entrada
            try { if (window && typeof recentlyAddedUnits !== 'undefined') { recentlyAddedUnits.add(newUnit.id); } } catch(e){}

            // Guardar en historial
            unitHistory.push({
                ...newUnit,
                startTime: now,
                endTime: null,
                createdBy: actor
            });

            nameInput.value = '';
            renderIncidents();
        }

        // Al eliminar una unidad, actualiza la hora de fin en el historial
        function deleteUnit(unitId) {
            if (!confirm("¿Estás seguro de que deseas eliminar esta unidad?")) return;
            // Quitar la unidad de los incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => id !== unitId)
            }));
            // Quitar la unidad de la lista principal
            units = units.filter(u => u.id !== unitId);

            // Actualizar hora de fin en historial
            const hist = unitHistory.find(h => h.id === unitId && !h.endTime);
            if (hist) {
                hist.endTime = new Date();
                try { hist.endedBy = getSessionName(); } catch(e){}
            }

            renderIncidents();
        }

        // Elimina todas las unidades
        function deleteAllUnits() {
            if (!confirm("¿Estás seguro de que deseas eliminar TODAS las unidades? Esto no se puede deshacer.")) return;
            // Quitar de incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => !units.find(u => u.id === id))
            }));

            // Actualizar historial de unidades
            unitHistory.forEach(h => {
                if (!h.endTime) {
                    h.endTime = new Date();
                    try { if (!h.endedBy) h.endedBy = getSessionName(); } catch(e){}
                }
            });

            units = [];
            renderIncidents();
        }

        // Elimina unidades por tipo
        function deleteUnitsByType(type) {
            const toDeleteIds = units.filter(u => u.type === type).map(u => u.id);

            // Quitar de incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => !toDeleteIds.includes(id))
            }));

            // Actualizar historial
            unitHistory.forEach(h => {
                if (toDeleteIds.includes(h.id) && !h.endTime) {
                    h.endTime = new Date();
                    try { if (!h.endedBy) h.endedBy = getSessionName(); } catch(e){}
                }
            });

            units = units.filter(u => u.type !== type);
            renderIncidents();
        }

        // Confirmación antes de borrar por tipo (botón discreto en header)
        function confirmDeleteUnitsByType(type) {
            if (confirm(`Eliminar todas las unidades de tipo ${type}? Esta acción no se puede deshacer.`)) {
                deleteUnitsByType(type);
            }
        }

        // Al agregar comentario a incidente, también lo agregas al historial
        function addComment(incidentId, commentText) {
            if (!commentText.trim()) return;
            const actor = getSessionName();
            const stamped = `${actor}: ${commentText}`;
            incidents = incidents.map(i => 
                i.id === incidentId ? { ...i, comments: [...i.comments, stamped] } : i
            );
            // Actualizar historial
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist) {
                hist.comments.push(stamped);
            }
            renderIncidents();
        }

        /**
         * Actualiza la frecuencia de radio de una unidad específica.
         */
        function updateUnitFrequency(unitId, newFreq) {
            units = units.map(u => 
                u.id === unitId ? { ...u, frequency: newFreq } : u
            );
            renderUnits();
        }

        function updateUnitStatus(unitId, newStatus) {
            units = units.map(u => 
                u.id === unitId ? { ...u, status: newStatus } : u
            );
            renderUnits();
        }

        function updateIncidentTitle(incidentId, newTitle) {
            incidents = incidents.map(i => 
                i.id === incidentId ? { ...i, title: newTitle } : i
            );
        }

        /**
         * Actualiza la Frecuencia de Coordinación del Incidente y propaga el cambio a las unidades asignadas.
         */
        function updateIncidentFrequency(incidentId, newFreq) {
            incidents = incidents.map(i => {
                if (i.id === incidentId) {
                    // Actualizar la frecuencia del incidente
                    i.coordinationFrequency = newFreq;
                    // Record this frequency as used during the incident lifecycle
                    if (!Array.isArray(i.usedFrequencies)) i.usedFrequencies = [newFreq];
                    else if (!i.usedFrequencies.includes(newFreq)) i.usedFrequencies.push(newFreq);
                    // Actualizar la frecuencia de las unidades asignadas
                    units = units.map(u => 
                        i.assignedUnits.includes(u.id) 
                            ? { ...u, frequency: newFreq } // <--- CAMBIO AUTOMÁTICO DE FRECUENCIA
                            : u
                    );
                }
                return i;
            });
            // Also update the live history entry so the history panel reflects frequency changes
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist) {
                hist.coordinationFrequency = newFreq;
                if (!Array.isArray(hist.usedFrequencies)) hist.usedFrequencies = [newFreq];
                else if (!hist.usedFrequencies.includes(newFreq)) hist.usedFrequencies.push(newFreq);
            }
            renderIncidents(); 
        }

        /**
         * Asigna o desasigna una unidad a un incidente, actualizando su estado y frecuencia.
         */
        function toggleAssignUnit(incidentId, unitId) {
            let unit = units.find(u => u.id === unitId);
            let incident = incidents.find(i => i.id === incidentId);

            if (!unit || !incident) return;

            const isAssigned = incident.assignedUnits.includes(unitId);

            if (isAssigned) {
                // Desasignar: quitar de la lista del incidente y devolver la unidad a Código 14/DEFAULT_FREQ
                incident.assignedUnits = incident.assignedUnits.filter(id => id !== unitId);
                unit.status = "Código 14";
                unit.frequency = DEFAULT_FREQ;
            } else {
                // Asignar
                const alreadyAssignedToOther = incidents.some(i => i.id !== incidentId && i.assignedUnits.includes(unitId));
                if (alreadyAssignedToOther) {
                    alert(`Unit ${unit.name} is already assigned to another active incident.`);
                    return;
                }
                incident.assignedUnits.push(unitId);
                unit.status = "Código 6";
                unit.frequency = incident.coordinationFrequency;

                // Registrar en historial si no está
                if (!incident.allUnits.includes(unitId)) {
                    incident.allUnits.push(unitId);
                    const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
                    if (hist && !hist.allUnits.includes(unitId)) {
                        hist.allUnits.push(unitId);
                    }
                }
            }

            units = [...units];
            incidents = [...incidents];
            renderIncidents();
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const btn = document.getElementById('toggleHistoryBtn');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.textContent = "Ocultar Historial";
                renderHistory();
            } else {
                panel.classList.add('hidden');
                btn.textContent = "Historial";
            }
        }

        function renderHistory() {
            // Incidentes
            const incidentList = document.getElementById('incidentHistory');
            if (incidentList) {
                incidentList.innerHTML = incidentHistory.map(i => 
                    `<li>
                        <span class="font-semibold">${i.title}</span>
                            <span class="text-xs text-gray-500">(${(() => {
                                // Determine frequencies to show: use usedFrequencies if present, otherwise coordinationFrequency
                                const used = Array.isArray(i.usedFrequencies) && i.usedFrequencies.length > 0 ? [...i.usedFrequencies] : [i.coordinationFrequency];
                                // If more than one frequency and Law Enforcement is present, omit it
                                const filtered = used.length > 1 ? used.filter(f => f !== 'Law Enforcement') : used;
                                return filtered.join(', ');
                            })()})</span>
                        <div class="text-xs text-gray-400">Inicio: ${i.startTime ? formatUTC(i.startTime) : ''}</div>
                        <div class="text-xs text-gray-400">Fin: ${i.endTime ? formatUTC(i.endTime) : 'En curso'}</div>
                        <div class="text-xs text-gray-400">Unidades participantes: ${
                            i.allUnits && i.allUnits.length
                                ? i.allUnits.map(uid => {
                                    const u = unitHistory.find(unit => unit.id === uid) || units.find(unit => unit.id === uid);
                                    return u ? u.name : '';
                                }).join(', ')
                                : 'Ninguna'
                        }</div>
                        <div class="text-sm text-gray-400">Comentarios: ${i.comments && i.comments.length ? i.comments.join(' | ') : 'Sin comentarios'}</div>
                    </li>`
                ).join('');
            }
            // Unidades
            const unitList = document.getElementById('unitHistory');
            if (unitList) {
                // Group unitHistory by type for clearer presentation
                const grouped = unitHistory.reduce((acc, u) => {
                    (acc[u.type] = acc[u.type] || []).push(u);
                    return acc;
                }, {});

                // Respect persisted unitTypes order and use full display names when possible
                const orderedTypes = [
                    ...unitTypes.filter(t => Object.prototype.hasOwnProperty.call(grouped, t)),
                    ...Object.keys(grouped).filter(t => !unitTypes.includes(t))
                ];

                unitList.innerHTML = orderedTypes.map(type => {
                    const items = grouped[type].map(u => `
                        <li>
                            <span class="font-semibold">${u.name}</span>
                            <span class="text-xs text-gray-500">(${typeAbbrev[u.type] || typeDisplayFull[u.type] || u.type})</span>
                            <div class="text-xs text-gray-400">Inicio: ${u.startTime ? formatUTC(u.startTime) : ''}</div>
                            <div class="text-xs text-gray-400">Fin: ${u.endTime ? formatUTC(u.endTime) : 'En servicio'}</div>
                            <span class="text-xs text-gray-400">Estado: ${u.status}, Frecuencia: ${u.frequency}</span>
                        </li>
                    `).join('');
                    const display = (typeDisplayFull && typeDisplayFull[type]) ? typeDisplayFull[type] : type;
                    return `<li class="mb-2"><div class="font-semibold text-sm">${display}</div><ul class="ml-2 list-disc">${items}</ul></li>`;
                }).join('');
            }
        }

        async function downloadHistory() {
            // Helper para formato UTC militar
            function formatUTC(date) {
                const d = new Date(date);
                const yyyy = d.getUTCFullYear();
                const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
                const dd = String(d.getUTCDate()).padStart(2, '0');
                const hh = String(d.getUTCHours()).padStart(2, '0');
                const min = String(d.getUTCMinutes()).padStart(2, '0');
                const ss = String(d.getUTCSeconds()).padStart(2, '0');
                return `${hh}:${min}:${ss} ${dd}/${mm}/${yyyy} UTC`;
            }

            // Helper: load image and return dataURL or null
            function loadImageDataUrl(src) {
                return new Promise((resolve) => {
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const data = canvas.toDataURL('image/png');
                                resolve(data);
                            } catch (e) { resolve(null); }
                        };
                        img.onerror = () => resolve(null);
                        img.src = '../Pictures/Screenshots/san_andreas_state_parks_logo.png';
                    } catch (e) { resolve(null); }
                });
            }

            const logoData = await loadImageDataUrl('../Pictures/Screenshots/san_andreas_state_parks_logo.png');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const margin = 40;
            let y = margin;
            const lineHeight = 14;

            // Header: logo + centered text
            const pageWidth = doc.internal.pageSize.width;
            const centerX = pageWidth / 2;
            const headerHeight = 54;
            if (logoData) {
                // draw logo on left
                try { doc.addImage(logoData, 'PNG', margin, y - 4, headerHeight, headerHeight); } catch(e) { /* ignore */ }
            }
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('State Resource Enforcement', centerX, y + 12, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Communications Center', centerX, y + 30, { align: 'center' });
            y += headerHeight + 6;
            doc.setDrawColor(0,0,0);
            doc.setLineWidth(0.8);
            doc.line(margin, y, pageWidth - margin, y);
            y += 12;

            // Incidentes
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('HISTORIAL DE INCIDENTES', margin, y);
            y += 18;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            incidentHistory.forEach(i => {
                if (y > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                doc.setFont(undefined, 'bold');
                doc.text(`Incidente: ${i.title}`, margin, y);
                doc.setFont(undefined, 'normal');
                y += lineHeight;
                if (i.createdBy) { doc.text(`Creado por: ${i.createdBy}`, margin, y); y += lineHeight; }
                doc.text(`Frecuencia: ${i.coordinationFrequency}`, margin, y);
                y += lineHeight;
                doc.text(`Inicio: ${i.startTime ? formatUTC(i.startTime) : ''}`, margin, y);
                y += lineHeight;
                doc.text(`Fin: ${i.endTime ? formatUTC(i.endTime) : 'En curso'}`, margin, y);
                if (i.endTime && i.endedBy) { y += lineHeight; doc.text(`Cerrado por: ${i.endedBy}`, margin, y); }
                y += lineHeight;
                const participants = i.allUnits && i.allUnits.length
                    ? i.allUnits.map(uid => (unitHistory.find(unit => unit.id === uid) || units.find(unit => unit.id === uid) || {}).name).filter(Boolean).join(', ')
                    : 'Ninguna';
                doc.text(`Unidades participantes: ${participants}`, margin, y);
                y += lineHeight;
                const used = Array.isArray(i.usedFrequencies) && i.usedFrequencies.length > 0 ? [...i.usedFrequencies] : [i.coordinationFrequency];
                const filtered = used.length > 1 ? used.filter(f => f !== 'Law Enforcement') : used;
                doc.text(`Frecuencias usadas: ${filtered.join(', ')}`, margin, y);
                y += lineHeight;
                doc.text(`Comentarios: ${i.comments && i.comments.length ? i.comments.join(' | ') : 'Sin comentarios'}`, margin, y);
                y += lineHeight * 1.5;
            });

            // Units grouped by type
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('HISTORIAL DE UNIDADES', margin, y);
            y += 18;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const grouped = unitHistory.reduce((acc, u) => { (acc[u.type] = acc[u.type] || []).push(u); return acc; }, {});
            // Respect unitTypes order and use display names
            const orderedTypes = [
                ...unitTypes.filter(t => Object.prototype.hasOwnProperty.call(grouped, t)),
                ...Object.keys(grouped).filter(t => !unitTypes.includes(t))
            ];
            orderedTypes.forEach(type => {
                if (y > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                const display = (typeDisplayFull && typeDisplayFull[type]) ? typeDisplayFull[type] : type;
                doc.setFont(undefined, 'bold');
                doc.text(display, margin, y);
                doc.setFont(undefined, 'normal');
                y += lineHeight;
                (grouped[type] || []).forEach(u => {
                    if (y > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                    const name = `- ${u.name} (${u.status})`;
                    doc.text(name, margin + 10, y);
                    y += lineHeight;
                    doc.text(`Inicio: ${u.startTime ? formatUTC(u.startTime) : ''}`, margin + 16, y);
                    y += lineHeight;
                    doc.text(`Fin: ${u.endTime ? formatUTC(u.endTime) : 'En servicio'}`, margin + 16, y);
                    if (u.createdBy) { y += lineHeight; doc.text(`Registrado por: ${u.createdBy}`, margin + 16, y); }
                    if (u.endTime && u.endedBy) { y += lineHeight; doc.text(`Eliminado por: ${u.endedBy}`, margin + 16, y); }
                    y += lineHeight;
                    doc.text(`Frecuencia: ${u.frequency}`, margin + 16, y);
                    y += lineHeight * 1.2;
                });
                y += lineHeight;
            });

            // Operators who interacted
            // Collect unique operator names from incidents (createdBy/endedBy/comments) and units (createdBy/endedBy)
            const opSet = new Set();
            try {
                (incidentHistory || []).forEach(i => {
                    if (i && i.createdBy) opSet.add(String(i.createdBy).trim());
                    if (i && i.endedBy) opSet.add(String(i.endedBy).trim());
                    if (i && Array.isArray(i.comments)) {
                        i.comments.forEach(c => {
                            const m = String(c || '').match(/^\s*([^:]+):\s/);
                            if (m && m[1]) opSet.add(m[1].trim());
                        });
                    }
                });
            } catch(e){}
            try {
                (unitHistory || []).forEach(u => {
                    if (u && u.createdBy) opSet.add(String(u.createdBy).trim());
                    if (u && u.endedBy) opSet.add(String(u.endedBy).trim());
                });
            } catch(e){}
            const operators = Array.from(opSet).filter(Boolean).sort((a,b)=> a.localeCompare(b, 'es', { sensitivity: 'base' }));
            if (operators.length > 0) {
                doc.addPage();
                y = margin;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('OPERADORES QUE INTERACTUARON', margin, y);
                y += 18;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                operators.forEach(name => {
                    if (y > doc.internal.pageSize.height - margin) { doc.addPage(); y = margin; }
                    doc.text(`- ${name}`, margin, y);
                    y += lineHeight;
                });
            }

            // Save the PDF with timestamped filename
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const fname = `historial_despacho_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.pdf`;
            doc.save(fname);

            // Nota: la limpieza total ahora se realiza desde el botón "Limpiar" del encabezado.
        }

        // --- 5. INICIALIZACIÓN ---
        // Try to locate the background logo dynamically and set CSS var
        function trySetLogo() {
            const candidates = [
                './san_andreas_state_parks_logo.png',
                './assets/san_andreas_state_parks_logo.png',
                '../Pictures/Screenshots/san_andreas_state_parks_logo.png',
                'file:///C:/Users/USER/Pictures/Screenshots/san_andreas_state_parks_logo.png',
                'file:///E:/Pictures/Screenshots/san_andreas_state_parks_logo.png'
            ];
            function testNext(idx){
                if (idx >= candidates.length) return;
                const img = new Image();
                img.onload = function(){
                    try { document.documentElement.style.setProperty('--bg-logo-url', `url("${candidates[idx]}")`); } catch(e){}
                };
                img.onerror = function(){ testNext(idx+1); };
                // prevent caching issues while testing
                const sep = candidates[idx].includes('?') ? '&' : '?';
                img.src = candidates[idx] + sep + 'cache=' + Date.now();
            }
            try { testNext(0); } catch(e){}
        }
        // Restaurar datos desde localStorage si existen
        (function initializeData(){
            const restored = restoreState();
            if (!restored) {
                units = [];
                incidents = [];
                incidentHistory = [];
                unitHistory = [];
                expandedTypes = {};
            }
            renderUnits();
            renderIncidents();
            // Attempt to set the background logo path dynamically
            trySetLogo();
            // Require authentication overlay
            requireAuth();
            // Ensure Admin button visibility reflects session
            updateAdminUI();
        })();

        // Inicializar modo oscuro desde localStorage
        (function() {
            const dm = localStorage.getItem('darkMode');
            if (dm === '1') {
                darkMode = true;
            }
            applyDarkMode();
        })();

        // --- Admin panel logic ---
        function openAdminPanel(){
            if (!isAdminSession()) { alert('Acceso restringido. Inicia sesión como Admin.'); return; }
            renderOperatorList();
            renderAccessLog();
            const el = document.getElementById('adminOverlay');
            if (el) el.classList.remove('hidden');
        }
        function closeAdminPanel(){
            const el = document.getElementById('adminOverlay');
            if (el) el.classList.add('hidden');
        }
        function sanitizeName(name){ return (name || '').replace(/\s+/g,' ').trim(); }
        function escapeHtml(s){
            return String(s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        async function adminCreateOperator(){
            const nameEl = document.getElementById('adminNewName');
            const passEl = document.getElementById('adminNewPass');
            const errEl = document.getElementById('adminCreateError');
            if (!nameEl || !passEl || !errEl) return;
            errEl.textContent = '';
            let name = sanitizeName(nameEl.value);
            const pass = (passEl.value || '').trim();
            if (!name) { errEl.textContent = 'Ingresa el nombre del operador.'; return; }
            if (!pass || pass.length < 4) { errEl.textContent = 'La contraseña debe tener al menos 4 caracteres.'; return; }
            if (pass === ADMIN_PASSWORD) { errEl.textContent = 'No uses la contraseña de administrador para operadores.'; return; }
            const hash = await sha256Hex(pass);
            const users = getUsers();
            if (users.some(u => u.hash === hash)) { errEl.textContent = 'Ya existe un operador con esa contraseña.'; return; }
            users.push({ name, hash, role: 'operator', pw: pass });
            saveUsers(users);
            nameEl.value = '';
            passEl.value = '';
            renderOperatorList();
        }
        function deleteOperator(hash){
            if (!confirm('¿Eliminar este operador?')) return;
            let users = getUsers();
            users = users.filter(u => u.hash !== hash);
            saveUsers(users);
            renderOperatorList();
        }
        function renderOperatorList(){
            const list = document.getElementById('operatorList');
            if (!list) return;
            const users = getUsers();
            const operators = users.filter(u => (u.role || 'operator') !== 'admin');
            if (operators.length === 0){
                list.innerHTML = '<li class="text-gray-500">No hay operadores creados.</li>';
                return;
            }
            list.innerHTML = operators.map(u => `
                <li class="nature-glass rounded px-3 py-2">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <div class="font-medium text-gray-800">${escapeHtml(u.name)}</div>
                            <div class="text-xs text-gray-600">Contraseña: <span class="font-mono">${escapeHtml(u.pw || 'no guardada')}</span></div>
                        </div>
                        <button onclick="deleteOperator('${u.hash}')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs h-7">Eliminar</button>
                    </div>
                </li>
            `).join('');
        }
        function renderAccessLog(){
            const list = document.getElementById('accessLogList');
            if (!list) return;
            const logs = getAccessLog().slice().sort((a,b)=> (b.at||0)-(a.at||0));
            if (logs.length === 0){
                list.innerHTML = '<li class="text-gray-500">Sin registros.</li>';
                return;
            }
            function fmt(ts){ try { return new Date(ts).toLocaleString('es-ES'); } catch(e){ return String(ts); } }
            list.innerHTML = logs.map(l => `
                <li class="flex justify-between gap-3 px-2 py-1 bg-white/60 dark:bg-gray-800/60 rounded">
                    <span><span class="font-medium">${escapeHtml(l.name||'')}</span> <span class="text-gray-500">(${escapeHtml(l.role||'')})</span></span>
                    <span class="text-gray-600">${fmt(l.at)}</span>
                </li>
            `).join('');
        }
        function clearAccessLog(){ saveAccessLog([]); renderAccessLog(); }

        // Cross-tab live sync: react to writes from other tabs/windows
        window.addEventListener('storage', function(e){
            try {
                // Main app state changed in another tab
                if (e.key === STORAGE_KEY) {
                    syncFromStorage();
                    return;
                }
                // Operators changed in another tab (admin panel section)
                if (typeof AUTH_USERS_KEY !== 'undefined' && e.key === AUTH_USERS_KEY) {
                    const adminOpen = document.getElementById('adminOverlay');
                    if (adminOpen && !adminOpen.classList.contains('hidden')) {
                        renderOperatorList();
                    }
                    return;
                }
                // Access log changed in another tab (admin panel section)
                if (typeof AUTH_ACCESS_LOG_KEY !== 'undefined' && e.key === AUTH_ACCESS_LOG_KEY) {
                    const adminOpen = document.getElementById('adminOverlay');
                    if (adminOpen && !adminOpen.classList.contains('hidden')) {
                        renderAccessLog();
                    }
                    return;
                }
            } catch(err) { /* ignore */ }
        });

        // Cierra el menú solo si el clic es fuera del menú y del botón
        document.addEventListener('click', function(event) {
            document.querySelectorAll('[id^="incident-status-menu-"]').forEach(menu => {
                // Si el menú está abierto
                if (!menu.classList.contains('hidden')) {
                    // Si el clic NO es sobre el menú ni sobre el botón que lo abre
                    const button = menu.previousElementSibling;
                    if (!menu.contains(event.target) && event.target !== button) {
                        menu.classList.add('hidden');
                    }
                }
            });
        });

        // Visible resizers: create and enable dragging
        (function(){
            const grid = document.getElementById('mainGrid');
            if (!grid) return;
            // helper to apply saved cols or default
            function applySaved() {
                try {
                    const raw = localStorage.getItem('gridCols');
                    if (raw) {
                        const arr = JSON.parse(raw);
                        if (Array.isArray(arr) && arr.length === 3) {
                            grid.style.gridTemplateColumns = arr.join(' ');
                        }
                    }
                } catch(e){}
            }
            applySaved();
            if (window.positionGridResizers) window.positionGridResizers();

            // remove existing resizers
            grid.querySelectorAll('.visible-resizer').forEach(n=>n.remove());

            for (let i=0;i<2;i++) {
                const r = document.createElement('div');
                r.className = 'visible-resizer';
                r.dataset.index = String(i);
                grid.appendChild(r);
                // add a small visible handle that opens a popup for fine adjustments
                const handle = document.createElement('button');
                handle.type = 'button';
                handle.className = 'resizer-handle';
                handle.title = 'Ajustar columnas';
                r.appendChild(handle);
                const popup = document.createElement('div');
                popup.className = 'resizer-popup hidden';
                popup.innerHTML = `
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button class="btn-dec" title="-1">-</button>
                        <input type="range" min="5" max="90" value="50" class="popup-range">
                        <button class="btn-inc" title="+1">+</button>
                    </div>
                    <div style="text-align:right;margin-top:6px;"><button class="btn-close">Cerrar</button></div>
                `;
                r.appendChild(popup);
                    // wire popup controls
                    handle.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        popup.classList.toggle('hidden');
                    });
                    popup.querySelector('.btn-close').addEventListener('click', (ev) => { popup.classList.add('hidden'); ev.stopPropagation(); });
                    const range = popup.querySelector('.popup-range');
                    const btnInc = popup.querySelector('.btn-inc');
                    const btnDec = popup.querySelector('.btn-dec');
                    function getCurrentPercents() {
                        const cols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                        const nums = cols.map(c => parseFloat(c));
                        const sum = nums.reduce((s,n)=>s+n,0);
                        return nums.map(n => Math.round((n/sum)*100));
                    }
                    function applyPercentLeft(leftPct, rightPct) {
                        const cols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                        let other = [];
                        for (let j=0;j<cols.length;j++) {
                            if (j===i) other.push(leftPct + '%');
                            else if (j===i+1) other.push(rightPct + '%');
                            else other.push(cols[j]);
                        }
                        grid.style.gridTemplateColumns = other.join(' ');
                        try { localStorage.setItem('gridCols', JSON.stringify(window.getComputedStyle(grid).gridTemplateColumns.split(' '))); } catch(e){}
                        if (window.positionGridResizers) window.positionGridResizers();
                    }
                    // initialize range with current
                    const init = getCurrentPercents();
                    range.value = init[i];
                    range.addEventListener('input', () => {
                        const val = parseInt(range.value,10);
                        const cur = getCurrentPercents();
                        const otherPct = Math.max(5, cur[i+1] - (val - cur[i]));
                        applyPercentLeft(val, otherPct);
                    });
                    btnInc.addEventListener('click', () => { range.value = Math.min(90, parseInt(range.value,10) + 1); range.dispatchEvent(new Event('input')); });
                    btnDec.addEventListener('click', () => { range.value = Math.max(5, parseInt(range.value,10) - 1); range.dispatchEvent(new Event('input')); });
                // style for handle and popup
                // small inline styles rely on existing CSS classes added below
                let dragging = false, startX = 0, startCols = [];
                r.addEventListener('pointerdown', (ev) => {
                    dragging = true; startX = ev.clientX;
                    startCols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                    r.setPointerCapture(ev.pointerId);
                });
                r.addEventListener('pointermove', (ev) => {
                    if (!dragging) return;
                    const rect = grid.getBoundingClientRect();
                    // compute gap between columns (CSS column-gap)
                    const cs = window.getComputedStyle(grid);
                    const gapPx = parseFloat(cs.columnGap || cs.getPropertyValue('column-gap') || 0);
                    const numCols = startCols.length;
                    const totalGap = gapPx * (numCols - 1);
                    const contentWidth = rect.width - totalGap;
                    const sumFr = startCols.reduce((s,x)=>s+parseFloat(x),0);
                    const colsPx = startCols.map(c => (parseFloat(c)/sumFr)*contentWidth);
                    const idx = parseInt(r.dataset.index,10);
                    const delta = ev.clientX - startX;
                    let left = colsPx[idx] + delta;
                    let right = colsPx[idx+1] - delta;
                    const min = 60;
                    if (left < min) { right -= (min-left); left = min; }
                    if (right < min) { left -= (min-right); right = min; }
                    const s = colsPx.reduce((a,b)=>a+b,0);
                    const leftPct = Math.round((left/s)*100);
                    const rightPct = Math.round((right/s)*100);
                    const other = [];
                    for (let j=0;j<startCols.length;j++) {
                        if (j===idx) other.push(leftPct + '%');
                        else if (j===idx+1) other.push(rightPct + '%');
                        else other.push(Math.round((colsPx[j]/s)*100) + '%');
                    }
                    grid.style.gridTemplateColumns = other.join(' ');
                    // After adjusting columns, reposition resizers so they sit in the middle of the gaps
                    if (window.positionGridResizers) window.positionGridResizers();
                });
                function stop(ev){ if (!dragging) return; dragging=false; try{ localStorage.setItem('gridCols', JSON.stringify(window.getComputedStyle(grid).gridTemplateColumns.split(' '))); }catch(e){} }
                r.addEventListener('pointerup', (e)=>{ stop(e); if (window.positionGridResizers) window.positionGridResizers(); });
                r.addEventListener('pointercancel', (e)=>{ stop(e); if (window.positionGridResizers) window.positionGridResizers(); });
            }

            function position(){
                const rect = grid.getBoundingClientRect();
                const cs = window.getComputedStyle(grid);
                const gapPx = parseFloat(cs.columnGap || cs.getPropertyValue('column-gap') || 0);
                const cols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                const sum = cols.reduce((s,x)=>s+parseFloat(x),0);
                let acc = 0;
                // contentWidth excludes gaps
                const totalGap = gapPx * (cols.length - 1);
                const contentWidth = rect.width - totalGap;
                grid.querySelectorAll('.visible-resizer').forEach((el,i)=>{
                    const w = (parseFloat(cols[i])/sum) * contentWidth;
                    acc += w;
                    // place resizer centered on the gap after this column
                    const leftPos = acc + (i * gapPx) + (gapPx / 2);
                    el.style.left = (leftPos - (gapPx/2)) + 'px';
                    el.style.width = (gapPx || 12) + 'px';
                    el.style.height = rect.height + 'px';
                });
            }
            // Expose for other code to call when columns change
            window.positionGridResizers = position;
            window.addEventListener('resize', position);
            setTimeout(position, 100);
        })();
    </script>
</body>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC5-FxOU8Y1PfUUsghrHMXg_BTjUO38zzc",
        authDomain: "dispatch-132ba.firebaseapp.com",
        databaseURL: "https://dispatch-132ba-default-rtdb.firebaseio.com",
    projectId: "dispatch-132ba",
    storageBucket: "dispatch-132ba.appspot.com",
    messagingSenderId: "824655764897",
    appId: "1:824655764897:web:8ca4db278fb1286c0d3fe0",
    measurementId: "G-KSFTFEVFHE"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  // 🔽 Conexión a la base de datos
  const db = getDatabase(app);

        // ========= Realtime sync for the app state (units/incidents/history) =========
        // Room path: all clients connected to this room share the same state
        // Room name can come from URL (?room=nombre), or localStorage, defaulting to 'default'
        const _rawRoom = (new URLSearchParams(location.search).get('room') || localStorage.getItem('dispatchRoom') || 'default');
        const roomName = String(_rawRoom).trim().replace(/[^\w\-]/g, '').slice(0, 40) || 'default';
        try { localStorage.setItem('dispatchRoom', roomName); } catch(e){}
        window.dispatchRoomName = roomName;
        const ROOM_PATH = `rooms/${roomName}`;
    const STATE_REF = ref(db, `${ROOM_PATH}/state`);

    // Identify this client to avoid echo loops
    const clientId = (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random()).slice(2);

    // Simple debounce helper to avoid excessive writes
    let _fbDebounceTimer;
    const debounce = (fn, ms) => (...args) => {
        clearTimeout(_fbDebounceTimer);
        _fbDebounceTimer = setTimeout(() => fn(...args), ms);
    };

    // Expose a global function so the main script can push state to Firebase
    window.firebaseSaveState = debounce((data) => {
        // Avoid writing while applying a remote snapshot
        if (window._firebaseIsApplying) return;
        try {
            set(STATE_REF, {
                ...data,
                _meta: { updatedAt: Date.now(), by: clientId }
            });
        } catch (e) {
            console.warn('Firebase save failed', e);
        }
    }, 150);

    // Listen for remote state updates
    onValue(STATE_REF, (snapshot) => {
        const payload = snapshot.val();
        if (!payload || typeof payload !== 'object') return;
        // If the last writer was this same client, skip to prevent feedback
        if (payload._meta && payload._meta.by === clientId) return;

        const rUnits = Array.isArray(payload.units) ? payload.units : [];
        const rIncidents = Array.isArray(payload.incidents) ? payload.incidents : [];
        const rIncidentHistory = Array.isArray(payload.incidentHistory) ? payload.incidentHistory : [];
        const rUnitHistory = Array.isArray(payload.unitHistory) ? payload.unitHistory : [];
        const rExpanded = (payload.expandedTypes && typeof payload.expandedTypes === 'object') ? payload.expandedTypes : {};

        try {
            window._firebaseIsApplying = true;
            if (typeof window.isRestoring !== 'undefined') window.isRestoring = true;

            // Apply remote state to the global app variables defined in the main script
            window.units = rUnits;
            window.incidents = rIncidents;
            window.incidentHistory = rIncidentHistory;
            window.unitHistory = rUnitHistory;
            window.expandedTypes = rExpanded;

            // Cache to localStorage for offline/refresh continuity
            try {
                const cache = {
                    units: rUnits,
                    incidents: rIncidents,
                    incidentHistory: rIncidentHistory,
                    unitHistory: rUnitHistory,
                    expandedTypes: rExpanded
                };
                localStorage.setItem(window.STORAGE_KEY, JSON.stringify(cache));
            } catch (e) { /* ignore */ }

            // Re-render UI
            try { if (typeof window.renderIncidents === 'function') window.renderIncidents(); } catch(e) { /* ignore */ }
            try { if (typeof window.renderUnits === 'function') window.renderUnits(); } catch(e) { /* ignore */ }
        } finally {
            if (typeof window.isRestoring !== 'undefined') window.isRestoring = false;
            window._firebaseIsApplying = false;
        }
    });

    // 🔽 Escuchar cambios en tiempo real en "prueba/"
    const referencia = ref(db, "prueba/");
    onValue(referencia, (snapshot) => {
        const data = snapshot.val();
        console.log("Datos actualizados:", data);
        const elemento = document.getElementById("mensaje");
        if (elemento) {
            if (data && typeof data === 'object' && 'mensaje' in data && data.mensaje) {
                elemento.textContent = String(data.mensaje);
            } else if (data && typeof data === 'string') {
                // Si el nodo es directamente un string
                elemento.textContent = data;
            } else {
                elemento.textContent = 'Sin datos';
            }
        }
    });

  // 🔽 Escribir un ejemplo de dato (opcional)
  set(ref(db, "prueba/"), {
    mensaje: "Bienvenido a tu panel"
  });

    // UI: mostrar room y la URL del archivo para inspección rápida
    try {
        const badge = document.getElementById('roomBadge');
        if (badge) {
            badge.textContent = `Room: ${roomName}`;
            badge.title = `Room: ${roomName}\nURL: ${window.location.href}`;
        }
            const input = document.getElementById('roomInput');
            const changeBtn = document.getElementById('roomChangeBtn');
            const copyBtn = document.getElementById('copyLinkBtn');
            if (input) input.value = roomName;
            const applyRoom = () => {
                const next = String((input && input.value) || '')
                    .trim()
                    .replace(/[^\w\-]/g, '')
                    .slice(0, 40) || 'default';
                try { localStorage.setItem('dispatchRoom', next); } catch(e){}
                const url = new URL(window.location.href);
                url.searchParams.set('room', next);
                // Also add a simple cache-buster to mitigate CDN/browser cache when sharing
                url.searchParams.set('v', String(Date.now()).slice(-6));
                window.location.href = url.toString();
            };
            if (changeBtn) changeBtn.addEventListener('click', applyRoom);
            if (input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyRoom(); });
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        const old = copyBtn.textContent;
                        copyBtn.textContent = 'Copiado';
                        setTimeout(() => { copyBtn.textContent = old || 'Copiar link'; }, 1200);
                    } catch (e) {
                        // ignore
                    }
                });
            }
    } catch (e) { /* ignore */ }
</script>
</html>
