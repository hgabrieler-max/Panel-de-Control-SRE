<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho - JS Simple (Frecuencias)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .unit-card { transition: background-color 0.2s; }
        body {
            background-color: #e6f2e6;
        }
        .nature-bg {
            background: linear-gradient(135deg, #e6f2e6 0%, #cce3d6 100%);
        }
        .nature-glass {
            background: rgba(255,255,255,0.65);
            box-shadow: 0 4px 24px rgba(34, 49, 34, 0.12);
            border: 1px solid rgba(34, 49, 34, 0.08);
            backdrop-filter: blur(3px);
        }
        /* Transiciones suaves para cambios de tema */
        body, .nature-bg, .nature-glass, .unit-card, .bg-white, .bg-gray-50, input, select, textarea, button {
            transition: background-color 320ms ease, color 320ms ease, border-color 320ms ease, box-shadow 320ms ease;
        }
        svg { transition: transform 320ms ease, fill 320ms ease, stroke 320ms ease; }
        /* Dark mode overrides */
        .dark body { background-color: #071026; }
        .dark .nature-bg { background: linear-gradient(135deg,#071726 0%,#0b2230 100%); }
        .dark .nature-glass {
            background: rgba(6,10,18,0.7) !important;
            box-shadow: 0 4px 24px rgba(2,6,23,0.7) !important;
            border: 1px solid rgba(255,255,255,0.04) !important;
            color: #e6eef8 !important;
        }
        .dark .bg-white, .dark .bg-gray-50, .dark .bg-gray-100 {
            background-color: #0b1220 !important;
            color: #dbeafe !important;
        }
        /* Inputs, selects y textarea en modo oscuro */
        .dark input, .dark select, .dark textarea, .dark .border {
            background-color: #071226 !important;
            color: #e6eef8 !important;
            border-color: rgba(255,255,255,0.06) !important;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: rgba(230,238,248,0.55) !important;
        }
        .dark select option { background-color: #071226; color: #e6eef8; }
        .dark .text-gray-700, .dark .text-gray-600, .dark .text-gray-500 { color: #cbd5e1 !important; }
        .dark .text-gray-800, .dark .text-gray-900 { color: #e6eef8 !important; }
        .dark .bg-gray-300, .dark .bg-gray-200 { background-color: #1f2937 !important; color: #e6eef8 !important; }
        .dark .bg-gray-300:hover { background-color: #374151 !important; }
        .dark .unit-card { background: transparent !important; }
          /* Ensure freq/status indicators are hidden in light mode and shown only in dark mode
              This is explicit CSS so it works even if Tailwind's generated dark: variants are missing */
          .freq-indicator, .status-indicator { display: none !important; }
          .dark .freq-indicator, .dark .status-indicator { display: inline-block !important; }
        /* Type-specific darker bars */
        .dark [data-type="Warden"] { background-color: #071033 !important; color: #bfdbfe !important; }
        .dark [data-type="Ranger"] { background-color: #052713 !important; color: #bbf7d0 !important; }
        .dark [data-type="AIR"] { background-color: #0b0f12 !important; color: #cbd5e1 !important; }
        .dark [data-type="TSU"] { background-color: #2b2a07 !important; color: #fef3c7 !important; }
        .dark [data-type="ISB"] { background-color: #071229 !important; color: #bfdbfe !important; }
        /* Visual for drag-over when reordering categories */
        .drag-over { outline: 3px dashed rgba(59,130,246,0.45); transform: translateY(-2px); }
        /* Visible resizers between columns */
        .visible-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px; /* interactive hit area */
            margin-left: -6px; /* center over boundary */
            background: transparent; /* invisible */
            border-left: none;
            border-right: none;
            cursor: col-resize;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* ensure fully transparent */
        }
        .visible-resizer:hover { background: transparent; }
    </style>
</head>
<body class="nature-bg p-4 min-h-screen">

    <div class="flex items-center justify-between mb-4 nature-glass p-4 rounded-lg">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-extrabold text-green-900">Panel de Control</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="darkModeBtn" onclick="toggleDarkMode()" class="bg-gray-200 hover:bg-gray-300 text-sm px-2 py-1 rounded" aria-pressed="false" title="Toggle dark mode">
                <!-- Icono inicial será insertado por applyDarkMode() -->
            </button>
        </div>
    </div>
    
    <div id="mainGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4 relative">
        
        <!-- Unidades: altura fija y scroll -->
        <div class="nature-glass rounded-lg p-4 h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-3 text-green-800">Unidades</h2>
            
            <div class="flex gap-2 mb-4">
                <input 
                    id="newUnitName" 
                    class="border px-2 py-1 rounded w-full" 
                    placeholder="New unit name (ej. 11G213)"
                    onkeydown="if(event.key === 'Enter') { addUnit(); }"
                >
                <select id="newUnitType" class="border rounded px-2 py-1">
                    <option value="Warden">Warden</option>
                    <option value="Ranger">Ranger</option>
                    <option value="AIR">AIR</option>
                    <option value="TSU">TSU</option>
                    <option value="ISB">ISB</option> <!-- Nueva opción -->
                </select>
                <button onclick="addUnit()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-semibold">Agregar</button>
            </div>
            
            <div id="unitsContainer" class="space-y-3">
                </div>

            <div class="mt-4">
                <button onclick="if(confirm('Are you sure you want to delete ALL units?')) deleteAllUnits();" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-2 py-1 rounded text-xs">
                    Eliminar todas las unidades
                </button>
            </div>
        </div>

        <!-- Incidentes: altura fija y scroll -->
        <div class="nature-glass rounded-lg p-4 col-span-1 md:col-span-1 h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-3 text-green-800">Incidentes</h2>
            <div class="flex gap-2 mb-4">
                <input 
                    id="newIncidentTitle" 
                    class="border px-2 py-1 rounded w-full" 
                    placeholder="New incident title (ej. Persecución)"
                    onkeydown="if(event.key === 'Enter') { addIncident(); }"
                >
                <button onclick="addIncident()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded font-semibold">Agregar</button>
            </div>
            <div id="incidentsContainer" class="space-y-4">
                </div>
        </div>

        <!-- Resúmenes: altura fija y scroll -->
        <div class="nature-glass space-y-4 h-[100vh] overflow-y-auto">
            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Frecuencias activas</h3>
                <ul id="frequencySummary" class="text-sm space-y-1">
                    <li>Law Enforcement: 0 unidades</li>
                </ul>
            </div>
            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Estado de Unidades</h3>
                <ul id="statusSummary" class="text-sm space-y-1">
                    </ul>
            </div>

            <div class="bg-white shadow-xl rounded-lg p-4">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Conteo de Unidades</h3>
                <ul id="unitTypeSummary" class="text-sm space-y-1">
                </ul>
            </div>

            <!-- Historial: nuevo panel añadido aquí -->
            <div class="bg-white shadow-xl rounded-lg p-4">
                <button 
                    id="toggleHistoryBtn"
                    onclick="toggleHistory()"
                    class="bg-gray-700 hover:bg-gray-900 text-white px-3 py-1 rounded font-semibold w-full mb-2"
                >
                    Historial
                </button>
                <div id="historyPanel" class="hidden mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-700">Historial de incidentes</h3>
                        <button 
                            onclick="downloadHistory()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs ml-2"
                            style="min-width: 110px;"
                        >
                            Descargar
                        </button>
                    </div>
                    <ul id="incidentHistory" class="text-sm space-y-1"></ul>
                    <h3 class="text-lg font-bold mt-4 mb-2 text-gray-700">Historial de unidades</h3>
                    <ul id="unitHistory" class="text-sm space-y-1"></ul>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- 1. DEFINICIONES GLOBALES ---
        const DEFAULT_FREQ = "Law Enforcement";
        
        // Colores y Etiquetas
        const typeColors = {
            Ranger: "bg-green-700/60 text-white",
            // Make Warden background less intense by using a semi-transparent blue
            Warden: "bg-blue-700/60 text-white",
            TSU: "bg-yellow-700/60 text-white",
            AIR: "bg-gray-700/60 text-white",
            ISB: "bg-indigo-700/60 text-white"
        };
        // Clases para la barra de cada tipo (fondo y texto)
        const typeBarClasses = {
            Ranger: 'bg-green-100/60 text-green-800',
            Warden: 'bg-blue-100/60 text-blue-800',
            TSU: 'bg-yellow-100/60 text-yellow-800',
            AIR: 'bg-gray-100/60 text-gray-800',
            ISB: 'bg-blue-50/60 text-blue-800'
        };
        const statusColors = {
            // Light / Dark variants so colors remain visible in both themes
            "Código 14": "bg-green-500 dark:bg-green-700",
            "Código 7": "bg-yellow-500 dark:bg-yellow-600",
            "Código 6": "bg-yellow-400 dark:bg-yellow-500",
            "Codigo Rojo": "bg-red-700 dark:bg-red-500",
        };
        const statusTextColors = {
            // Use darker text in light mode, and white in dark mode for contrast
            "Código 14": "text-green-900 dark:text-white",
            "Código 7": "text-yellow-900 dark:text-white",
            "Código 6": "text-yellow-900 dark:text-white",
            "Codigo Rojo": "text-red-900 dark:text-white",
        };
        
        // ¡LISTA DE FRECUENCIAS ACTUALIZADA!
        const frequencies = [
            "Law Enforcement",
            "Park Frequency",
            "TAC-1",
            "TAC-2",
            "TAC-3",
            "TAC-4",
            "TAC-5",
            "LTAC-1",
            "LTAC-2",
            "LTAC-3",
            "LTAC-4",
            "LTAC-5",
            "WTAC-1",
            "WTAC-2",
            "WTAC-3",
            "WLTAC-1",
            "WLTAC-2",
            "WLTAC-3",
            "MAID-1",
            "MAID-2",
            "MAID-3",
            "MAID-4",
            "MAID-5",
            "MAID-6",
        ];

    // Devuelve clases Tailwind para una frecuencia (colores en modo claro + variantes dark)
    function getFrequencyClasses(freq) {
        // TAC, LTAC, WTAC, WLTAC -> amarillo
        if (/^(TAC|LTAC|WTAC|WLTAC)/.test(freq)) {
            return 'bg-yellow-200 text-yellow-800 dark:bg-yellow-600 dark:text-white';
        }
        // MAID -> naranja
        if (/^MAID/.test(freq)) {
            return 'bg-orange-200 text-orange-800 dark:bg-orange-600 dark:text-white';
        }
        // Law Enforcement y Park Frequency -> verde
        if (freq === 'Law Enforcement' || freq === 'Park Frequency') {
            return 'bg-green-200 text-green-800 dark:bg-green-700 dark:text-white';
        }
        // Default
        return 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-white';
    }

    const defaultUnitTypes = ["Warden", "Ranger", "AIR", "TSU", "ISB"];
    // Persistible order of unit types. Load from localStorage or use default order.
    function loadUnitTypes() {
        try {
            const raw = localStorage.getItem('unitTypesOrder');
            if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length > 0) return parsed;
            }
        } catch (e) { /* ignore */ }
        return [...defaultUnitTypes];
    }
    function saveUnitTypes(arr) {
        try { localStorage.setItem('unitTypesOrder', JSON.stringify(arr)); } catch(e){}
    }
    let unitTypes = loadUnitTypes();
    // Mapa de nombres de despliegue para las categorías (nombres completos) y abreviaturas para las etiquetas
    const typeDisplayFull = {
        Warden: 'S.A Fish And Wildlife',
        Ranger: 'S.A Parks And Recreation',
        AIR: 'Aviation Unit',
        ISB: 'Investigative Service Branch',
        TSU: 'Traffic Safety Unit'
    };
    const typeAbbrev = {
        Warden: 'SAFW',
        Ranger: 'SAPR',
        AIR: 'AIR',
        ISB: 'ISB',
        TSU: 'TSU'
    };
    // Estado de expansión por tipo (true = abierto)
    let expandedTypes = {};

        // Dark mode state
        let darkMode = false;
    // Control de animación del icono (evitar durante la carga inicial)
    let iconAnimationEnabled = true;

        function applyDarkMode() {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                document.body.classList.add('bg-gray-900', 'text-gray-100');
                const btn = document.getElementById('darkModeBtn');
                if (btn) {
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zM4.22 4.22a1 1 0 011.415 0l.707.707a1 1 0 11-1.414 1.414l-.708-.707a1 1 0 010-1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm8 7a1 1 0 011-1v-1a1 1 0 10-2 0v1a1 1 0 011 1zm6.364-13.364a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM16 9a1 1 0 011 1v0a1 1 0 11-2 0 1 1 0 011-1zM4.22 15.778a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM14.95 14.95a1 1 0 10-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707z" />
                        </svg>
                    `;
                    btn.setAttribute('aria-pressed', 'true');
                    // Animación rápida de rotación si está permitido
                    if (iconAnimationEnabled) {
                        const svg = btn.querySelector('svg');
                        if (svg) {
                            svg.style.transition = 'transform 300ms ease';
                            svg.style.transform = 'rotate(360deg)';
                            setTimeout(() => { svg.style.transform = ''; }, 350);
                        }
                    }
                }
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900', 'text-gray-100');
                const btn = document.getElementById('darkModeBtn');
                if (btn) {
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M17.293 13.293A8 8 0 116.707 2.707a7 7 0 0010.586 10.586z" />
                        </svg>
                    `;
                    btn.setAttribute('aria-pressed', 'false');
                    if (iconAnimationEnabled) {
                        const svg = btn.querySelector('svg');
                        if (svg) {
                            svg.style.transition = 'transform 300ms ease';
                            svg.style.transform = 'rotate(360deg)';
                            setTimeout(() => { svg.style.transform = ''; }, 350);
                        }
                    }
                }
            }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode ? '1' : '0');
            applyDarkMode();
        }
        const statusOptions = ["Código 14", "Código 7", "Código 6", "Codigo Rojo"];

        // --- 2. GESTIÓN DE ESTADO (DATOS) ---
        let units = [];
        let incidents = [];

        // Historiales globales
        let incidentHistory = [];
        let unitHistory = [];

        // --- 3. FUNCIONES DE RENDERIZADO (DIBUJAR LA PANTALLA) ---

        /**
         * Dibuja y actualiza la lista completa de unidades y el resumen.
         */
        function renderUnits() {
            const container = document.getElementById('unitsContainer');
            if (!container) return;
            container.innerHTML = '';

            // Agrupar unidades por tipo
            const unitsByType = unitTypes.reduce((acc, type) => {
                acc[type] = units.filter(u => u.type === type);
                return acc;
            }, {});

            // Orden natural (alfanumérico) dentro de cada categoría
            for (const t of unitTypes) {
                unitsByType[t].sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            }

            for (const type of unitTypes) {
                const section = document.createElement('div');
                section.className = 'mt-2';
                section.setAttribute('draggable', 'true');
                section.dataset.type = type;

                // Header plegable
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between cursor-pointer select-none p-2 rounded';
                const barClasses = typeBarClasses[type] || 'bg-gray-100 text-gray-700';
                // In light mode we want a slightly transparent bar for visual softness
                const opacityClass = darkMode ? '' : ' bg-opacity-60';
                header.innerHTML = `
                    <div class="w-full">
                            <div 
                            data-type="${type}" 
                            class="flex items-center justify-between ${barClasses}${opacityClass} rounded px-3 py-1 cursor-pointer transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-400" 
                            onclick="toggleType('${type}')" 
                            role="button" 
                            tabindex="0" 
                            onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); toggleType('${type}'); }"
                        >
                            <div class="text-left flex items-center gap-2">
                                <span class="font-bold">${typeDisplayFull[type] || type}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); confirmDeleteUnitsByType('${type}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-2 py-0.5 rounded text-xs">Eliminar</button>
                                <span id="chevron-${type}" class="opacity-80"></span>
                            </div>
                        </div>
                    </div>
                `;
                // Drag & drop handlers to reorder categories
                section.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', type);
                    e.dataTransfer.effectAllowed = 'move';
                    section.classList.add('opacity-70');
                });
                section.addEventListener('dragend', (e) => {
                    section.classList.remove('opacity-70');
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                });
                section.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    section.classList.add('drag-over');
                    e.dataTransfer.dropEffect = 'move';
                });
                section.addEventListener('dragleave', (e) => {
                    section.classList.remove('drag-over');
                });
                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    section.classList.remove('drag-over');
                    const fromType = e.dataTransfer.getData('text/plain');
                    const toType = type;
                    if (fromType && toType && fromType !== toType) {
                        reorderTypes(fromType, toType);
                        renderUnits();
                    }
                });

                section.appendChild(header);

                // Contenedor de unidades (colapsable, sin animación al renderizar)
                const listDiv = document.createElement('div');
                listDiv.id = `unitsList-${type}`;
                // Use a responsive grid: 1 column on small screens, 2 columns on md+ so units appear 2 per row
                listDiv.className = 'mt-2 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden';
                // Disable transition during render to avoid animation on add/remove
                listDiv.style.transition = 'none';

                // Determinar estado inicial (usar expandedTypes si está definido)
                if (expandedTypes[type] === undefined) {
                    // Por defecto: abierto si hay unidades, cerrado si no
                    expandedTypes[type] = unitsByType[type].length > 0;
                }

                // Añadir tarjetas de unidad dentro del listDiv
                unitsByType[type].forEach(u => {
                    const isAssigned = incidents.some(i => i.assignedUnits.includes(u.id));

                    const unitElement = document.createElement('div');
                    // Make the card responsive: stack content vertically on small, arrange in a row on md+ so it fits two per line
                    unitElement.className = `unit-card p-4 rounded-lg shadow-md text-base border-l-4 ${typeColors[u.type]} ${isAssigned ? 'border-red-500' : 'border-green-500'} flex flex-col md:flex-row justify-between items-center min-h-20`;
                    unitElement.innerHTML = `
                        <div>
                            <p class="font-bold text-base">${u.name}</p>
                            <span class="block mt-1 inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-opacity-60 ${typeColors[u.type] || 'bg-gray-200 text-gray-800'}" title="${typeDisplayFull[u.type] || u.type}">${typeAbbrev[u.type] || u.type}</span>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <div class="flex items-center gap-2">
                                <!-- Small color indicator for frequency: hidden in light mode, visible (smaller) in dark mode -->
                                <span id="freqIndicator-${u.id}" class="freq-indicator w-6 h-4 rounded-md ${getFrequencyClasses(u.frequency)} dark:ring-1 dark:ring-white/10 shadow-sm" title="${u.frequency}" aria-hidden="true"></span>
                                <select 
                                    onchange="updateUnitFrequency(${u.id}, this.value)" 
                                    class="border rounded px-1 py-0.5 text-xs ${getFrequencyClasses(u.frequency)}"
                                    ${isAssigned ? 'disabled title="Assigned to incident"' : ''} 
                                >
                                    ${frequencies.map(f => `<option value="${f}" ${u.frequency === f ? 'selected' : ''}>${f}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <!-- Small color indicator for status: hidden in light mode, visible (smaller) in dark mode -->
                                <span id="statusIndicator-${u.id}" class="status-indicator w-6 h-4 rounded-md ${statusColors[u.status] || 'bg-gray-200'} ${statusTextColors[u.status] || 'text-gray-800'} dark:ring-1 dark:ring-white/10 shadow-sm" title="${u.status}" aria-hidden="true"></span>
                                <select 
                                    onchange="updateUnitStatus(${u.id}, this.value)" 
                                    class="border rounded px-1 py-0.5 text-xs text-gray-800 dark:text-white ${statusColors[u.status]} ${statusTextColors[u.status] || ''}"
                                    ${isAssigned ? 'disabled title="Assigned to incident"' : ''}
                                >
                                    ${statusOptions.map(s => `<option value="${s}" ${u.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            
                            <button 
                                onclick="deleteUnit(${u.id})" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-0.5 rounded text-xs"
                                title="Eliminar unidad"
                            >
                                Eliminar
                            </button>
                        </div>
                    `;

                    listDiv.appendChild(unitElement);
                });

                // After building list, set open/closed state without animation based on expandedTypes
                if (expandedTypes[type]) {
                    // open: remove maxHeight restriction so it grows naturally
                    listDiv.style.maxHeight = '';
                    listDiv.dataset.open = 'true';
                    const chevron = document.getElementById(`chevron-${type}`);
                    if (chevron) chevron.textContent = '▲';
                } else {
                    // closed
                    listDiv.style.maxHeight = '0px';
                    listDiv.dataset.open = 'false';
                    const chevron = document.getElementById(`chevron-${type}`);
                    if (chevron) chevron.textContent = '▼';
                }

                section.appendChild(listDiv);
                container.appendChild(section);
            }

            renderSummaries();
        }

        // Reordena unitTypes intercambiando la posición de fromType y toType (swap) y persiste
        function reorderTypes(fromType, toType) {
            const fromIdx = unitTypes.indexOf(fromType);
            const toIdx = unitTypes.indexOf(toType);
            if (fromIdx === -1 || toIdx === -1) return;
            // Swap
            const tmp = unitTypes[fromIdx];
            unitTypes[fromIdx] = unitTypes[toIdx];
            unitTypes[toIdx] = tmp;
            saveUnitTypes(unitTypes);
        }

        // Alterna la visibilidad de la lista de un tipo de unidad con animación
        // La animación se aplica dinámicamente sólo cuando el usuario pulsa la flecha.
        function toggleType(type) {
            const list = document.getElementById(`unitsList-${type}`);
            const chevron = document.getElementById(`chevron-${type}`);
            if (!list) return;
            const isOpen = list.dataset.open === 'true';

            // Activar transición justo antes de cambiar para que no ocurra durante render
            list.style.transition = 'max-height 300ms ease';

            if (isOpen) {
                // Colapsar: establecer maxHeight al valor actual y forzar reflow antes de 0
                const current = list.scrollHeight;
                list.style.maxHeight = current + 'px';
                // Forzar reflow
                void list.offsetHeight;
                list.style.maxHeight = '0px';
                list.dataset.open = 'false';
                expandedTypes[type] = false;
                if (chevron) chevron.textContent = '▼';
            } else {
                // Expandir: establecer maxHeight al scrollHeight actual
                const full = list.scrollHeight;
                list.style.maxHeight = full + 'px';
                list.dataset.open = 'true';
                expandedTypes[type] = true;
                if (chevron) chevron.textContent = '▲';
            }

            // Después de la transición, limpiar el estilo inline para permitir crecimiento natural
            list.addEventListener('transitionend', function handler() {
                // Si está abierto, quitar max-height para permitir que crezca con contenido dinámico
                if (list.dataset.open === 'true') {
                    list.style.maxHeight = '';
                }
                // Desactivar la transición hasta la próxima interacción
                list.style.transition = 'none';
                list.removeEventListener('transitionend', handler);
            });
        }

        /**
         * Dibuja y actualiza la lista de incidentes.
         */
        function renderIncidents() {
            const container = document.getElementById('incidentsContainer');
            if (!container) return;
            container.innerHTML = '';

            incidents.forEach(i => {
                const incidentElement = document.createElement('div');
                incidentElement.className = "p-4 rounded-lg border-t-4 border-red-600 bg-gray-50 shadow-lg";
                incidentElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <input 
                            type="text" 
                            value="${i.title}" 
                            onchange="updateIncidentTitle(${i.id}, this.value)" 
                            class="font-bold text-lg w-full bg-transparent"
                        >
                        <button onclick="deleteIncident(${i.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm ml-2">X</button>
                    </div>

                    <div class="mb-3 text-sm flex items-center">
                        <label class="mr-2 font-medium">Coord. Freq:</label>
                        <select 
                            onchange="updateIncidentFrequency(${i.id}, this.value)" 
                            class="border rounded px-2 py-1 text-xs ${getFrequencyClasses(i.coordinationFrequency)}"
                        >
                            ${frequencies.map(f => `<option value="${f}" ${i.coordinationFrequency === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>

                    <div class="mb-2 flex gap-2">
                        <label class="font-medium text-xs mr-2">Estado:</label>
                        <select onchange="updateIncidentStatus(${i.id}, this.value)" class="border rounded px-2 py-1 text-xs">
                            <option value="activo" ${i.active && !i.codigo4 ? 'selected' : ''}>Activo</option>
                            <option value="codigo4" ${i.codigo4 ? 'selected' : ''}>Código 4</option>
                        </select>
                    </div>

                    <p class="font-medium text-gray-600 mb-2">Assigned Units:</p>
                    <div id="assignedUnits-${i.id}" class="flex flex-wrap gap-2 mb-3 border-t pt-2">
                        ${unitTypes.map(type =>
                            units
                                .filter(u => u.type === type)
                                .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}))
                                .map(u => {
                                    const isAssigned = i.assignedUnits.includes(u.id);
                                    const isAssignedToOther = !isAssigned && incidents.some(otherI =>
                                        otherI.id !== i.id && otherI.assignedUnits.includes(u.id)
                                    );

                                    if (isAssignedToOther) {
                                        return `
                                            <span class="px-2 py-1 rounded text-xs font-semibold bg-gray-300 text-gray-500 opacity-50 cursor-not-allowed">
                                                ${u.name} (🔒)
                                            </span>
                                        `;
                                    }

                                    return `
                                        <button 
                                            onclick="toggleAssignUnit(${i.id}, ${u.id})" 
                                            class="px-2 py-1 rounded text-xs font-semibold transition ${isAssigned ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                                        >
                                            ${u.name} ${isAssigned ? '✅' : ''}
                                        </button>
                                    `;
                                })
                                .join('')
                        ).join('')}
                    </div>

                    <p class="font-medium text-gray-600">Comments (Enter to add):</p>
                    <input 
                        id="comment-${i.id}"
                        type="text" 
                        placeholder="Add comment..."
                        onkeydown="if(event.key === 'Enter') { addComment(${i.id}, this.value); this.value = ''; }"
                        class="border rounded px-2 py-1 w-full text-sm mt-1"
                    >
                    <div id="comments-${i.id}" class="text-sm mt-1 space-y-0.5">
                        ${i.comments.map(c => `<p class="italic text-gray-400 text-sm">${c}</p>`).join('')}
                    </div>
                `;
                container.appendChild(incidentElement);
            });
            renderUnits();
        }

        // Helpers para el menú plegable de estado de incidente
        function toggleIncidentStatusMenu(incidentId) {
            document.querySelectorAll('[id^="incident-status-menu-"]').forEach(el => el.classList.add('hidden'));
            const menu = document.getElementById(`incident-status-menu-${incidentId}`);
            if (menu) menu.classList.toggle('hidden');
        }
        function hideIncidentStatusMenu(incidentId) {
            const menu = document.getElementById(`incident-status-menu-${incidentId}`);
            if (menu) menu.classList.add('hidden');
        }

        // Formatea una fecha a UTC con formato militar HH:MM:SS DD/MM/YYYY UTC
        function formatUTC(date) {
            const d = new Date(date);
            const yyyy = d.getUTCFullYear();
            const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(d.getUTCDate()).padStart(2, '0');
            const hh = String(d.getUTCHours()).padStart(2, '0');
            const min = String(d.getUTCMinutes()).padStart(2, '0');
            const ss = String(d.getUTCSeconds()).padStart(2, '0');
            return `${hh}:${min}:${ss} ${dd}/${mm}/${yyyy} UTC`;
        }

        /**
         * Dibuja los resúmenes de frecuencia y estado.
         */
        function renderSummaries() {
            // Resumen de Frecuencia
            const freqContainer = document.getElementById('frequencySummary');
            if (freqContainer) {
                const freqCount = {};
                units.forEach(u => {
                    freqCount[u.frequency] = (freqCount[u.frequency] || 0) + 1;
                });
                // Ordenar por el nombre de la frecuencia para que el resumen sea consistente
                const sortedFrequencies = frequencies.filter(f => freqCount[f] > 0);
                
                freqContainer.innerHTML = sortedFrequencies.map(freq => 
                    `<li><span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${getFrequencyClasses(freq)}">${freq}</span> <strong class="ml-2 text-blue-600">${freqCount[freq]}</strong> unidades</li>`
                ).join('');
            }

            // Resumen de Estado
            const statusContainer = document.getElementById('statusSummary');
            if (statusContainer) {
                const statusCount = {};
                units.forEach(u => {
                    statusCount[u.status] = (statusCount[u.status] || 0) + 1;
                });
                statusContainer.innerHTML = Object.entries(statusCount).map(([status, count]) => 
                    `<li>${status}: <strong class="text-blue-600">${count}</strong> unidades</li>`
                ).join('');
            }

            // Resumen por Tipo de Unidad
            const typeContainer = document.getElementById('unitTypeSummary');
            if (typeContainer) {
                const typeCount = {};
                units.forEach(u => {
                    typeCount[u.type] = (typeCount[u.type] || 0) + 1;
                });
                // Mostrar todos los tipos de unidades, incluso los que tienen 0
                typeContainer.innerHTML = unitTypes.map(type => 
                    `<li class="flex justify-between">
                        <span class="inline-block px-2 py-0.5 rounded-full bg-opacity-60 text-xs font-semibold ${typeColors[type]}">${typeAbbrev[type] || type}</span>
                        <strong class="text-blue-600">${typeCount[type] || 0}</strong>
                    </li>`
                ).join('');
            }
        }


        // --- 4. FUNCIONES DE LOGICA (MANIPULACIÓN DE DATOS) ---

        // Al crear un incidente, lo agregas al historial con hora de inicio y lista de unidades vacía
        function addIncident() {
            const titleInput = document.getElementById('newIncidentTitle');
            const newTitle = titleInput.value.trim();

            if (!newTitle) {
                alert("Please enter an incident title.");
                return;
            }

            const now = new Date();
            const newIncident = {
                id: Date.now(),
                title: newTitle,
                assignedUnits: [],
                coordinationFrequency: DEFAULT_FREQ,
                // Track frequencies used during lifecycle of the incident
                usedFrequencies: [DEFAULT_FREQ],
                comments: [],
                startTime: now,
                endTime: null,
                allUnits: [],
                active: true,      // Incidente activo por defecto
                codigo4: false     // No está en código 4 por defecto
            };

            incidents.push(newIncident);

            incidentHistory.push({
                ...newIncident,
                units: [],
                comments: [],
                startTime: now,
                endTime: null,
                allUnits: [],
                // mirror the used frequencies into the history entry
                usedFrequencies: Array.isArray(newIncident.usedFrequencies) ? [...newIncident.usedFrequencies] : [newIncident.coordinationFrequency],
                active: true,
                codigo4: false
            });

            titleInput.value = '';
            renderIncidents();
        }

        // Al eliminar un incidente, actualiza la hora de fin en el historial y registra todas las unidades que participaron
        function deleteIncident(incidentId) {
            if (!confirm("¿Estás seguro de que deseas eliminar este incidente? Las unidades asignadas pasarán a Código 14.")) return;
            const incidentToDelete = incidents.find(i => i.id === incidentId);

            // Liberar unidades asignadas
            if (incidentToDelete) {
                units = units.map(u => 
                    incidentToDelete.assignedUnits.includes(u.id) 
                        ? { ...u, status: "Código 14", frequency: DEFAULT_FREQ } 
                        : u
                );
            }

            // Actualizar hora de fin en historial y registrar todas las unidades que participaron
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist && incidentToDelete) {
                hist.endTime = new Date();
                hist.units = [...incidentToDelete.assignedUnits];
                hist.comments = [...incidentToDelete.comments];
                hist.allUnits = [...incidentToDelete.allUnits];
                // Ensure usedFrequencies is recorded in history (fall back to coordinationFrequency)
                hist.usedFrequencies = Array.isArray(incidentToDelete.usedFrequencies) && incidentToDelete.usedFrequencies.length > 0
                    ? [...incidentToDelete.usedFrequencies]
                    : [incidentToDelete.coordinationFrequency];
            }

            incidents = incidents.filter(i => i.id !== incidentId);
            renderIncidents();
        }

        // Al crear una unidad, la agregas al historial con hora de registro
        function addUnit() {
            const nameInput = document.getElementById('newUnitName');
            const typeInput = document.getElementById('newUnitType');
            const newName = nameInput.value.trim();
            const newType = typeInput.value;

            if (!newName) {
                alert("Please enter a unit name.");
                return;
            }

            const now = new Date();
            const newUnit = {
                id: Date.now(),
                name: newName.toUpperCase(),
                status: "Código 14",
                type: newType,
                frequency: DEFAULT_FREQ
            };

            units.push(newUnit);

            // Guardar en historial
            unitHistory.push({
                ...newUnit,
                startTime: now,
                endTime: null
            });

            nameInput.value = '';
            renderIncidents();
        }

        // Al eliminar una unidad, actualiza la hora de fin en el historial
        function deleteUnit(unitId) {
            if (!confirm("¿Estás seguro de que deseas eliminar esta unidad?")) return;
            // Quitar la unidad de los incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => id !== unitId)
            }));
            // Quitar la unidad de la lista principal
            units = units.filter(u => u.id !== unitId);

            // Actualizar hora de fin en historial
            const hist = unitHistory.find(h => h.id === unitId && !h.endTime);
            if (hist) {
                hist.endTime = new Date();
            }

            renderIncidents();
        }

        // Elimina todas las unidades
        function deleteAllUnits() {
            if (!confirm("¿Estás seguro de que deseas eliminar TODAS las unidades? Esto no se puede deshacer.")) return;
            // Quitar de incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => !units.find(u => u.id === id))
            }));

            // Actualizar historial de unidades
            unitHistory.forEach(h => {
                if (!h.endTime) h.endTime = new Date();
            });

            units = [];
            renderIncidents();
        }

        // Elimina unidades por tipo
        function deleteUnitsByType(type) {
            if (!confirm(`¿Estás seguro de que deseas eliminar todas las unidades de tipo ${type}?`)) return;

            const toDeleteIds = units.filter(u => u.type === type).map(u => u.id);

            // Quitar de incidentes
            incidents = incidents.map(i => ({
                ...i,
                assignedUnits: i.assignedUnits.filter(id => !toDeleteIds.includes(id))
            }));

            // Actualizar historial
            unitHistory.forEach(h => {
                if (toDeleteIds.includes(h.id) && !h.endTime) h.endTime = new Date();
            });

            units = units.filter(u => u.type !== type);
            renderIncidents();
        }

        // Confirmación antes de borrar por tipo (botón discreto en header)
        function confirmDeleteUnitsByType(type) {
            if (!confirm(`Eliminar todas las unidades de tipo ${type}? Esta acción no se puede deshacer.`)) return;
            deleteUnitsByType(type);
        }

        // Al agregar comentario a incidente, también lo agregas al historial
        function addComment(incidentId, commentText) {
            if (!commentText.trim()) return;
            incidents = incidents.map(i => 
                i.id === incidentId ? { ...i, comments: [...i.comments, commentText] } : i
            );
            // Actualizar historial
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist) {
                hist.comments.push(commentText);
            }
            renderIncidents();
        }

        /**
         * Actualiza la frecuencia de radio de una unidad específica.
         */
        function updateUnitFrequency(unitId, newFreq) {
            units = units.map(u => 
                u.id === unitId ? { ...u, frequency: newFreq } : u
            );
            renderUnits();
        }

        function updateUnitStatus(unitId, newStatus) {
            units = units.map(u => 
                u.id === unitId ? { ...u, status: newStatus } : u
            );
            renderUnits();
        }

        function updateIncidentTitle(incidentId, newTitle) {
            incidents = incidents.map(i => 
                i.id === incidentId ? { ...i, title: newTitle } : i
            );
        }

        /**
         * Actualiza la Frecuencia de Coordinación del Incidente y propaga el cambio a las unidades asignadas.
         */
        function updateIncidentFrequency(incidentId, newFreq) {
            incidents = incidents.map(i => {
                if (i.id === incidentId) {
                    // Actualizar la frecuencia del incidente
                    i.coordinationFrequency = newFreq;
                    // Record this frequency as used during the incident lifecycle
                    if (!Array.isArray(i.usedFrequencies)) i.usedFrequencies = [newFreq];
                    else if (!i.usedFrequencies.includes(newFreq)) i.usedFrequencies.push(newFreq);
                    // Actualizar la frecuencia de las unidades asignadas
                    units = units.map(u => 
                        i.assignedUnits.includes(u.id) 
                            ? { ...u, frequency: newFreq } // <--- CAMBIO AUTOMÁTICO DE FRECUENCIA
                            : u
                    );
                }
                return i;
            });
            // Also update the live history entry so the history panel reflects frequency changes
            const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
            if (hist) {
                hist.coordinationFrequency = newFreq;
                if (!Array.isArray(hist.usedFrequencies)) hist.usedFrequencies = [newFreq];
                else if (!hist.usedFrequencies.includes(newFreq)) hist.usedFrequencies.push(newFreq);
            }
            renderIncidents(); 
        }

        /**
         * Asigna o desasigna una unidad a un incidente, actualizando su estado y frecuencia.
         */
        function toggleAssignUnit(incidentId, unitId) {
            let unit = units.find(u => u.id === unitId);
            let incident = incidents.find(i => i.id === incidentId);

            if (!unit || !incident) return;

            const isAssigned = incident.assignedUnits.includes(unitId);

            if (isAssigned) {
                // Desasignar: quitar de la lista del incidente y devolver la unidad a Código 14/DEFAULT_FREQ
                incident.assignedUnits = incident.assignedUnits.filter(id => id !== unitId);
                unit.status = "Código 14";
                unit.frequency = DEFAULT_FREQ;
            } else {
                // Asignar
                const alreadyAssignedToOther = incidents.some(i => i.id !== incidentId && i.assignedUnits.includes(unitId));
                if (alreadyAssignedToOther) {
                    alert(`Unit ${unit.name} is already assigned to another active incident.`);
                    return;
                }
                incident.assignedUnits.push(unitId);
                unit.status = "Código 6";
                unit.frequency = incident.coordinationFrequency;

                // Registrar en historial si no está
                if (!incident.allUnits.includes(unitId)) {
                    incident.allUnits.push(unitId);
                    const hist = incidentHistory.find(h => h.id === incidentId && !h.endTime);
                    if (hist && !hist.allUnits.includes(unitId)) {
                        hist.allUnits.push(unitId);
                    }
                }
            }

            units = [...units];
            incidents = [...incidents];
            renderIncidents();
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const btn = document.getElementById('toggleHistoryBtn');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.textContent = "Ocultar Historial";
                renderHistory();
            } else {
                panel.classList.add('hidden');
                btn.textContent = "Historial";
            }
        }

        function renderHistory() {
            // Incidentes
            const incidentList = document.getElementById('incidentHistory');
            if (incidentList) {
                incidentList.innerHTML = incidentHistory.map(i => 
                    `<li>
                        <span class="font-semibold">${i.title}</span>
                            <span class="text-xs text-gray-500">(${(() => {
                                // Determine frequencies to show: use usedFrequencies if present, otherwise coordinationFrequency
                                const used = Array.isArray(i.usedFrequencies) && i.usedFrequencies.length > 0 ? [...i.usedFrequencies] : [i.coordinationFrequency];
                                // If more than one frequency and Law Enforcement is present, omit it
                                const filtered = used.length > 1 ? used.filter(f => f !== 'Law Enforcement') : used;
                                return filtered.join(', ');
                            })()})</span>
                        <div class="text-xs text-gray-400">Inicio: ${i.startTime ? formatUTC(i.startTime) : ''}</div>
                        <div class="text-xs text-gray-400">Fin: ${i.endTime ? formatUTC(i.endTime) : 'En curso'}</div>
                        <div class="text-xs text-gray-400">Unidades participantes: ${
                            i.allUnits && i.allUnits.length
                                ? i.allUnits.map(uid => {
                                    const u = unitHistory.find(unit => unit.id === uid) || units.find(unit => unit.id === uid);
                                    return u ? u.name : '';
                                }).join(', ')
                                : 'Ninguna'
                        }</div>
                        <div class="text-sm text-gray-400">Comentarios: ${i.comments && i.comments.length ? i.comments.join(' | ') : 'Sin comentarios'}</div>
                    </li>`
                ).join('');
            }
            // Unidades
            const unitList = document.getElementById('unitHistory');
            if (unitList) {
                unitList.innerHTML = unitHistory.map(u => 
                    `<li>
                        <span class="font-semibold">${u.name}</span>
                        <span class="text-xs text-gray-500">(${u.type})</span>
                        <div class="text-xs text-gray-400">Inicio: ${u.startTime ? formatUTC(u.startTime) : ''}</div>
                        <div class="text-xs text-gray-400">Fin: ${u.endTime ? formatUTC(u.endTime) : 'En servicio'}</div>
                        <span class="text-xs text-gray-400">Estado: ${u.status}, Frecuencia: ${u.frequency}</span>
                    </li>`
                ).join('');
            }
        }

        function downloadHistory() {
            // Helper para formato UTC militar
            function formatUTC(date) {
                const d = new Date(date);
                const yyyy = d.getUTCFullYear();
                const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
                const dd = String(d.getUTCDate()).padStart(2, '0');
                const hh = String(d.getUTCHours()).padStart(2, '0');
                const min = String(d.getUTCMinutes()).padStart(2, '0');
                const ss = String(d.getUTCSeconds()).padStart(2, '0');
                return `${hh}:${min}:${ss} ${dd}/${mm}/${yyyy} UTC`;
            }

            let text = "=== HISTORIAL DE INCIDENTES ===\n\n";
            incidentHistory.forEach(i => {
                text += `Incidente: ${i.title}\n`;
                text += `Frecuencia: ${i.coordinationFrequency}\n`;
                text += `Inicio: ${i.startTime ? formatUTC(i.startTime) : ''}\n`;
                text += `Fin: ${i.endTime ? formatUTC(i.endTime) : 'En curso'}\n`;
                text += `Unidades participantes: ${
                    i.allUnits && i.allUnits.length
                        ? i.allUnits.map(uid => {
                            const u = unitHistory.find(unit => unit.id === uid) || units.find(unit => unit.id === uid);
                            return u ? u.name : '';
                        }).join(', ')
                        : 'Ninguna'
                }\n`;
                // Write used frequencies to export applying rule: omit Law Enforcement unless it was the only frequency used
                const used = Array.isArray(i.usedFrequencies) && i.usedFrequencies.length > 0 ? [...i.usedFrequencies] : [i.coordinationFrequency];
                const filtered = used.length > 1 ? used.filter(f => f !== 'Law Enforcement') : used;
                text += `Frecuencias usadas: ${filtered.join(', ')}\n`;
                text += `Comentarios: ${i.comments && i.comments.length ? i.comments.join(' | ') : 'Sin comentarios'}\n`;
                text += "\n";
            });

            text += "\n=== HISTORIAL DE UNIDADES ===\n\n";
            unitHistory.forEach(u => {
                text += `Unidad: ${u.name}\n`;
                text += `Tipo: ${u.type}\n`;
                text += `Inicio: ${u.startTime ? formatUTC(u.startTime) : ''}\n`;
                text += `Fin: ${u.endTime ? formatUTC(u.endTime) : 'En servicio'}\n`;
                text += `Estado: ${u.status}, Frecuencia: ${u.frequency}\n`;
                text += "\n";
            });

            // Crear y descargar el archivo
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "historial_despacho.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 5. INICIALIZACIÓN ---
        
        // Cargar algunas unidades e incidentes de prueba al inicio
        function initializeData() {
            units = [];
            incidents = [];
        }

        // Llamada inicial para dibujar la interfaz al cargar la página
        initializeData();
        renderUnits();
        renderIncidents(); 

        // Inicializar modo oscuro desde localStorage
        (function() {
            const dm = localStorage.getItem('darkMode');
            if (dm === '1') {
                darkMode = true;
            }
            applyDarkMode();
        })();

        // Cierra el menú solo si el clic es fuera del menú y del botón
        document.addEventListener('click', function(event) {
            document.querySelectorAll('[id^="incident-status-menu-"]').forEach(menu => {
                // Si el menú está abierto
                if (!menu.classList.contains('hidden')) {
                    // Si el clic NO es sobre el menú ni sobre el botón que lo abre
                    const button = menu.previousElementSibling;
                    if (!menu.contains(event.target) && event.target !== button) {
                        menu.classList.add('hidden');
                    }
                }
            });
        });

        // Visible resizers: create and enable dragging
        (function(){
            const grid = document.getElementById('mainGrid');
            if (!grid) return;
            // helper to apply saved cols or default
            function applySaved() {
                try {
                    const raw = localStorage.getItem('gridCols');
                    if (raw) {
                        const arr = JSON.parse(raw);
                        if (Array.isArray(arr) && arr.length === 3) {
                            grid.style.gridTemplateColumns = arr.join(' ');
                        }
                    }
                } catch(e){}
            }
            applySaved();
            if (window.positionGridResizers) window.positionGridResizers();

            // remove existing resizers
            grid.querySelectorAll('.visible-resizer').forEach(n=>n.remove());

            for (let i=0;i<2;i++) {
                const r = document.createElement('div');
                r.className = 'visible-resizer';
                r.dataset.index = String(i);
                grid.appendChild(r);
                let dragging = false, startX = 0, startCols = [];
                r.addEventListener('pointerdown', (ev) => {
                    dragging = true; startX = ev.clientX;
                    startCols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                    r.setPointerCapture(ev.pointerId);
                });
                r.addEventListener('pointermove', (ev) => {
                    if (!dragging) return;
                    const rect = grid.getBoundingClientRect();
                    // compute gap between columns (CSS column-gap)
                    const cs = window.getComputedStyle(grid);
                    const gapPx = parseFloat(cs.columnGap || cs.getPropertyValue('column-gap') || 0);
                    const numCols = startCols.length;
                    const totalGap = gapPx * (numCols - 1);
                    const contentWidth = rect.width - totalGap;
                    const sumFr = startCols.reduce((s,x)=>s+parseFloat(x),0);
                    const colsPx = startCols.map(c => (parseFloat(c)/sumFr)*contentWidth);
                    const idx = parseInt(r.dataset.index,10);
                    const delta = ev.clientX - startX;
                    let left = colsPx[idx] + delta;
                    let right = colsPx[idx+1] - delta;
                    const min = 60;
                    if (left < min) { right -= (min-left); left = min; }
                    if (right < min) { left -= (min-right); right = min; }
                    const s = colsPx.reduce((a,b)=>a+b,0);
                    const leftPct = Math.round((left/s)*100);
                    const rightPct = Math.round((right/s)*100);
                    const other = [];
                    for (let j=0;j<startCols.length;j++) {
                        if (j===idx) other.push(leftPct + '%');
                        else if (j===idx+1) other.push(rightPct + '%');
                        else other.push(Math.round((colsPx[j]/s)*100) + '%');
                    }
                    grid.style.gridTemplateColumns = other.join(' ');
                    // After adjusting columns, reposition resizers so they sit in the middle of the gaps
                    if (window.positionGridResizers) window.positionGridResizers();
                });
                function stop(ev){ if (!dragging) return; dragging=false; try{ localStorage.setItem('gridCols', JSON.stringify(window.getComputedStyle(grid).gridTemplateColumns.split(' '))); }catch(e){} }
                r.addEventListener('pointerup', (e)=>{ stop(e); if (window.positionGridResizers) window.positionGridResizers(); });
                r.addEventListener('pointercancel', (e)=>{ stop(e); if (window.positionGridResizers) window.positionGridResizers(); });
            }

            function position(){
                const rect = grid.getBoundingClientRect();
                const cs = window.getComputedStyle(grid);
                const gapPx = parseFloat(cs.columnGap || cs.getPropertyValue('column-gap') || 0);
                const cols = window.getComputedStyle(grid).gridTemplateColumns.split(' ');
                const sum = cols.reduce((s,x)=>s+parseFloat(x),0);
                let acc = 0;
                // contentWidth excludes gaps
                const totalGap = gapPx * (cols.length - 1);
                const contentWidth = rect.width - totalGap;
                grid.querySelectorAll('.visible-resizer').forEach((el,i)=>{
                    const w = (parseFloat(cols[i])/sum) * contentWidth;
                    acc += w;
                    // place resizer centered on the gap after this column
                    const leftPos = acc + (i * gapPx) + (gapPx / 2);
                    el.style.left = (leftPos - (gapPx/2)) + 'px';
                    el.style.width = (gapPx || 12) + 'px';
                    el.style.height = rect.height + 'px';
                });
            }
            // Expose for other code to call when columns change
            window.positionGridResizers = position;
            window.addEventListener('resize', position);
            setTimeout(position, 100);
        })();
    </script>
</body>
</html>
